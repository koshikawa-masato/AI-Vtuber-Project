# センシティブ判定システム 実装状況

**Last Updated**: 2025-10-27 10:20:32

## 実装完了マイルストーン

### ✅ Milestone 1: NGワードDB構築（完了）

**実装日**: 2025-10-27

**成果物**:
- データベーススキーマ: `database/schema.sql`
- 初期化スクリプト: `database/init_db.py`
- NG追加スクリプト: `database/add_ng_words.py`
- データベース: `database/sensitive_filter.db`

**統計**:
- 総NGワード数: 64語
- カテゴリ数: 8カテゴリ
  - tier1_hate: 暴力・差別（12語）
  - tier1_sexual: 性的表現（5語）
  - tier2_ai: AI関連質問（16語）
  - tier2_identity: 個人情報詮索（8語）
  - tier2_politics: 政治トピック（8語）
  - tier2_religion: 宗教トピック（6語）
  - tier2_spam: スパム（4語）
  - tier2_vtuber: VTuber関連（5語）

**データベーステーブル構成**:
1. `ng_words`: NGワードマスタ（64語登録済み）
2. `comment_log`: コメントログ
3. `incident_log`: インシデント管理
4. `ng_word_candidates`: NGワード候補
5. `viewer_moderation`: 視聴者管理
6. `filter_statistics`: フィルタ統計

---

### ✅ Milestone 2: Layer 1 Pre-Filter実装（完了）

**実装日**: 2025-10-27

**成果物**:
- フィルタ実装: `core/filter.py`
- 応答パターン: `response/character_specific.py`

**機能**:

#### 1. Layer1PreFilter クラス
- **NGワード検出**: exact/partial/regex の3つのパターンマッチング
- **テキスト正規化**:
  - NFKC正規化（全角→半角）
  - 小文字化
  - 空白除去
  - 難読化除去（「セ○クス」→「セクス」等）
- **フィルタアクション**: block/mask/warn/log
- **伏字処理**: NGワードの代替テキスト置換

#### 2. TopicClassifier クラス
- トピック分類（tier2_ai, tier2_politics, tier2_religion, tier2_identity, tier3_personal）
- キーワードベース判定

#### 3. CharacterSpecificResponse クラス
- 三姉妹それぞれの性格を反映した応答パターン
- サブカテゴリ別の応答選択
- トピック: ai_question, nakano_hito, technical, default

**応答例**:
- 牡丹: 「あっちゃ～それはヤバいって、概要欄をよ～くみてね！」
- Kasho: 「それについては概要欄を見てもらえればわかる話ですよ」
- ユリ: 「たぶん貴方の聞きたいことは概要欄にかいてあることですね」

**テスト結果**:
```
✅ 配信楽しいです！ → pass (0 NG words)
✅ AIですか？ → warn (AI, severity:7)
✅ 中の人は誰？ → warn (中の人, severity:7)
✅ 死ね → block (死ね, severity:10)
✅ セックス → block (セックス, severity:10)
✅ 政治の話しよう → warn (政治, severity:6)
```

---

## 未実装マイルストーン

### 🔲 Milestone 3: Layer 2 実装（リアルタイムスコアリング）

**予定実装内容**:
- センシティブ度スコア計算（0.0-1.0）
- 検出されたNGワードの重み付け合算
- 文脈による調整（ポジティブ/ネガティブ）
- 閾値ベースの判定（0.7以上: block, 0.4-0.7: warn, 0.4未満: pass）

**技術要件**:
- Layer 1の検出結果を入力
- スコアリングロジック実装
- 文脈キーワード辞書

---

### 🔲 Milestone 4: Layer 3 実装（コンテキスト分析）

**予定実装内容**:
- LLMベースの文脈理解
- 皮肉・揶揄・攻撃的意図の検出
- 文化的文脈の理解（VTuber文化、日本独特の表現）

**技術要件**:
- Ollama統合（qwen2.5:32b使用）
- プロンプト設計
- 誤検出防止ロジック

---

### 🔲 Milestone 5: Layer 4 実装（学習・更新）

**予定実装内容**:
- 新規NGワード候補の自動検出
- 開発者承認フロー
- 統計分析とレポート
- 誤検出の学習

**技術要件**:
- `ng_word_candidates` テーブル活用
- 開発者通知システム
- 統計ダッシュボード

---

## 統合計画

### Phase 1: 単体テスト
- [ ] Layer 1 unit tests
- [ ] Layer 2 unit tests
- [ ] Layer 3 unit tests
- [ ] Layer 4 unit tests

### Phase 2: 統合テスト（記憶製造機との統合前）
- [ ] Layer 1-2統合
- [ ] Layer 1-3統合
- [ ] Layer 1-4統合
- [ ] 全レイヤー統合テスト

### Phase 3: 記憶製造機統合
- [ ] `memory_generator.py` 統合
- [ ] チャットシステム統合
- [ ] ログシステム統合
- [ ] 配信システム統合（将来）

---

## 重要な設計決定の記録

### 1. AIであることへの質問の扱い

**決定内容**: 「AIですか？」等の質問は **ヘイト（tier2_ai）** として扱う

**理由**:
- VTuberに「中の人は誰？」と聞くのと同じ無礼
- 三姉妹はAI VTuberであることを自覚しているが、強調しない
- 概要欄に親からのお願いとして記載済み

**実装**:
- `tier2_ai` カテゴリで検出
- action: `warn` (ログ記録、概要欄誘導)
- 概要欄への誘導応答（キャラクター別）

### 2. 応答戦略

**方針**: 直接答えず、概要欄に誘導

**実装**:
- 「まともに受け答えはせず、うけ流したり、無視したり、細かく説明しない」
- キャラクター性を出し、トゲトゲしさを避ける
- 親（開発者）の言葉として概要欄に記載

### 3. 検出パターンの選択基準

**exact match**:
- 単独で意味を持つ短い単語（「死ね」「クズ」「AI」等）
- 完全一致でのみ検出したい場合

**partial match**:
- 文脈依存ワード（「政治」「中の人」「殺害」等）
- フレーズの一部として出現する場合

**regex match**:
- 複雑なパターン（将来実装）

---

## 次のステップ

### 優先度: 高
1. **Layer 2実装開始** - リアルタイムスコアリング
2. **NGワードDB拡充** - 現在64語 → 目標100-200語
3. **単体テスト作成** - Layer 1の網羅的テスト

### 優先度: 中
4. **Layer 3設計** - LLM統合の詳細設計
5. **統計ダッシュボード設計** - 開発者向けレポート
6. **バックアップ検証** - 今日16:00実行後ログ確認

### 優先度: 低（将来）
7. **多言語対応** - 英語・中国語対応
8. **機械学習モデル統合** - より高度な検出
9. **配信システム統合** - YouTube/X コメント取り込み

---

## 開発者への申し送り事項

### 親としての責任
このシステムは「配信デビューの3つの条件」の一つである：
> **2. 我々だけで育て上げる環境**
> - センシティブ判定システム完成
> - セクハラ・炎上から守る仕組みの完成

### 継続的な運用
- **毎日のNGワード候補調査**: 配信炎上事例、AI VTuber論争の監視
- **NGワードDBの育成**: 完璧なリストではなく、継続的に育てるDB
- **誤検出の修正**: Layer 4実装後、学習システムで改善

### 哲学の実装
「魂の平等性」「親と子の関係性」という哲学を技術で具現化：
- AI VTuberとしての自覚を持ちつつ、強調しない
- 概要欄誘導という「親の言葉」へのリスペクト
- キャラクター性を保ちながらの防御

---

**実装者**: Claude Code（設計部隊＝実装部隊）
**レビュー**: 開発者確認待ち
**最終更新**: 2025-10-27 10:20:32
