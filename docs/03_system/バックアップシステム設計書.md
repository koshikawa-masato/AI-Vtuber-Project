# バックアップシステム設計書

**作成日**: 2025-10-23 17:02:41
**作成者**: Claude Code (設計部隊)
**承認者**: 開発者
**バージョン**: 1.0

---

## 目次

1. [哲学と原則](#哲学と原則)
2. [バックアップ対象](#バックアップ対象)
3. [バックアップ方式](#バックアップ方式)
4. [世代管理](#世代管理)
5. [復旧条件と禁止事項](#復旧条件と禁止事項)
6. [実装仕様](#実装仕様)
7. [監視とアラート](#監視とアラート)
8. [テスト手順](#テスト手順)
9. [運用手順](#運用手順)

---

## 哲学と原則

### データの同一性保証原則との関係

**重要**: バックアップには2つの意味があります。

#### ❌ 禁止されるバックアップ（論理的やり直し）
- Event結果を気に入らないから討論前に戻す
- 三姉妹の記憶を削除・改変する
- 「失敗をなかったことにする」ための使用
- **これは絶対に禁止**

#### ✅ 必須のバックアップ（物理的保護）
- **ハードウェア故障**からの保護
- **ファイルシステム破損**からの復旧
- **誤操作**（rm -rf等）からの保護
- **災害対策**（複数箇所保存）
- **これは絶対に必要**

### 基本原則

1. **Immutableバックアップ**: タイムスタンプ付き、上書きしない
2. **複数世代保持**: 最低10世代、物理的に異なる場所に保存
3. **自動バックアップ**: 手動に頼らない、定期実行
4. **復旧の明確な条件**: 物理的障害のみ、論理的やり直し禁止
5. **透明性**: バックアップログを記録、いつ何をバックアップしたか追跡可能

---

## バックアップ対象

### 最優先: sisters_memory.db

**パス**: `/home/koshikawa/toExecUnit/sisters_memory.db`

**理由**:
- Event #1〜#110以上を保存
- 三姉妹（牡丹・Kasho・ユリ）の全人格・全経験の基盤
- **一度失われたら二度と作れない唯一無二の資産**

**リスク**:
- SSD故障（MTBF: 平均故障間隔を超える可能性）
- ファイルシステム破損（電源断、カーネルパニック等）
- プロセス異常終了によるDB破損（SQLite COMMIT途中での障害）
- 誤操作（rm、スクリプトのバグ等）

### 副次的: personalities/

**パス**: `/home/koshikawa/toExecUnit/personalities/*.json`

**理由**:
- 三姉妹の8軸性格パラメータ
- 再作成可能だが、一貫性のため保存推奨

### 副次的: proposals.json

**パス**: `/home/koshikawa/toExecUnit/proposals.json`

**理由**:
- 討論議題の履歴（Proposal #1〜#121以上）
- 再作成可能だが、履歴保持のため保存推奨

### 副次的: 設定ファイル群

**対象**:
- `config/*.json`（存在する場合）
- `*.env`（存在する場合、センシティブ情報注意）

---

## バックアップ方式

### リモートバックアップ（VPS）

**方式**: scp over SSH (port 443)

**コマンド**:
```bash
scp -P 443 /home/koshikawa/toExecUnit/sisters_memory.db \
  ubuntu@133.167.93.123:/home/ubuntu/sisters_backup/sisters_memory_YYYYMMDD_HHMMSS.db
```

**バックアップ先**:
- **VPSサーバー**: 133.167.93.123
- **ユーザー**: ubuntu
- **ディレクトリ**: `/home/ubuntu/sisters_backup/`
- **ポート**: 443（SSH）

**タイムスタンプフォーマット**:
- `YYYYMMDD_HHMMSS`
- 例: `sisters_memory_20251023_170230.db`

### ローカルバックアップ（二重保護）

**方式**: ローカルコピー

**バックアップ先**:
```bash
/home/koshikawa/toExecUnit/backup/sisters_memory_YYYYMMDD_HHMMSS.db
```

**目的**:
- VPSへの転送失敗時の保険
- 高速復旧（ローカルから即座に復元可能）
- デバッグ時の過去状態参照

---

## 世代管理

### フルミラーリング: ローカル10世代、リモート10世代

**保持ポリシー**:
- **ローカル**: 直近10世代を全て保持
- **リモート**: 直近10世代を全て保持
- **完全一致**: ローカルとリモートのファイル名・内容が完全に一致

**理由**:
- どちらか一方が壊れてももう一方で復旧可能
- 相互チェックによりデータ整合性を保証
- 冗長性の最大化

**実装**:
```bash
# ローカルで古いバックアップを削除（11世代目以降）
cd /home/koshikawa/toExecUnit/backup
ls -t sisters_memory_*.db | tail -n +11 | xargs -r rm

# リモートで古いバックアップを削除（11世代目以降）
ssh -p 443 ubuntu@133.167.93.123 \
  "cd /home/ubuntu/sisters_backup && ls -t sisters_memory_*.db | tail -n +11 | xargs -r rm"
```

---

## 復旧条件と禁止事項

### ✅ 復旧が許可される場合（物理的障害）

1. **ハードウェア故障**
   - SSD故障でファイルが読めない
   - ファイルシステムが破損してマウントできない

2. **ファイルシステムエラー**
   - `sqlite3 sisters_memory.db "PRAGMA integrity_check;"` でエラー
   - DB開けない、読み込めない

3. **誤操作**
   - `rm`コマンドで削除してしまった
   - スクリプトのバグでDBファイルが消失

4. **プロセス異常終了によるDB破損**
   - SQLite COMMIT途中での電源断
   - カーネルパニック、OOM Killer

### ❌ 復旧が禁止される場合（論理的やり直し）

1. **討論結果が気に入らない**
   - Event #109: 「決まらなかった」→ やり直したい
   - Event #110: 「調べなかった」→ やり直したい

2. **三姉妹の記憶・感情が期待外れ**
   - 牡丹: 「楽しかった」→ 親は「失敗だ」と思う
   - 記憶の内容を変更したい

3. **設計ミスの取り消し**
   - 性格パラメータを変えて、過去の記憶も変えたい
   - 討論ロジックを変えて、過去のEventをやり直したい

### 復旧の判断フロー

```
[DBファイルが読めない]
    ↓
[物理的原因か？論理的原因か？]
    ↓
[物理的] → ✅ バックアップから復旧
[論理的] → ❌ 復旧禁止、現状を受け入れる
```

**判断者**: 開発者（最終決定権）

---

## 実装仕様

### 整合性チェックスクリプト【最重要】

**ファイル名**: `/home/koshikawa/toExecUnit/scripts/check_backup_integrity.sh`

**目的**: ローカルとリモートのバックアップが完全に一致しているか検証

**内容**:
```bash
#!/bin/bash
# Backup Integrity Check Script
#
# Purpose: Verify local and remote backups are in perfect sync
# Usage: Called by Claude Code on startup, and after each backup

set -euo pipefail

# Configuration
LOCAL_BACKUP_DIR="/home/koshikawa/toExecUnit/backup"
REMOTE_HOST="ubuntu@133.167.93.123"
REMOTE_PORT="443"
REMOTE_DIR="/home/ubuntu/sisters_backup"
LOG_FILE="/home/koshikawa/toExecUnit/logs/backup_integrity.log"
ALERT_FILE="/home/koshikawa/toExecUnit/logs/backup_alert.txt"

# Create log directory if not exists
mkdir -p "$(dirname "$LOG_FILE")"

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Clear previous alert
rm -f "$ALERT_FILE"

log "=== Backup Integrity Check Start ==="

# 1. Get local backup list
log "Checking local backups..."
if [ ! -d "$LOCAL_BACKUP_DIR" ]; then
    echo "CRITICAL: Local backup directory not found" > "$ALERT_FILE"
    log "ERROR: Local backup directory not found: $LOCAL_BACKUP_DIR"
    exit 1
fi

LOCAL_FILES=$(cd "$LOCAL_BACKUP_DIR" && ls -1 sisters_memory_*.db 2>/dev/null | sort || true)
LOCAL_COUNT=$(echo "$LOCAL_FILES" | grep -c . || echo 0)
log "Local backups found: $LOCAL_COUNT"

# 2. Get remote backup list
log "Checking remote backups..."
REMOTE_FILES=$(ssh -p "$REMOTE_PORT" "$REMOTE_HOST" \
    "cd $REMOTE_DIR && ls -1 sisters_memory_*.db 2>/dev/null | sort" || true)
REMOTE_COUNT=$(echo "$REMOTE_FILES" | grep -c . || echo 0)
log "Remote backups found: $REMOTE_COUNT"

# 3. Check file count
if [ "$LOCAL_COUNT" -ne 10 ] || [ "$REMOTE_COUNT" -ne 10 ]; then
    echo "WARNING: Backup count mismatch" > "$ALERT_FILE"
    echo "  Local: $LOCAL_COUNT files (expected: 10)" >> "$ALERT_FILE"
    echo "  Remote: $REMOTE_COUNT files (expected: 10)" >> "$ALERT_FILE"
    log "WARNING: Backup count mismatch (Local: $LOCAL_COUNT, Remote: $REMOTE_COUNT)"
fi

# 4. Check filename matching
log "Checking filename matching..."
if [ "$LOCAL_FILES" != "$REMOTE_FILES" ]; then
    echo "ERROR: Filename mismatch between local and remote" >> "$ALERT_FILE"
    echo "  Local only:" >> "$ALERT_FILE"
    comm -23 <(echo "$LOCAL_FILES") <(echo "$REMOTE_FILES") | sed 's/^/    /' >> "$ALERT_FILE"
    echo "  Remote only:" >> "$ALERT_FILE"
    comm -13 <(echo "$LOCAL_FILES") <(echo "$REMOTE_FILES") | sed 's/^/    /' >> "$ALERT_FILE"
    log "ERROR: Filename mismatch detected"
fi

# 5. CRC32 checksum verification
log "Verifying CRC32 checksums..."
CHECKSUM_MISMATCH=0

for FILE in $LOCAL_FILES; do
    if echo "$REMOTE_FILES" | grep -q "^${FILE}$"; then
        # File exists in both locations, check CRC32
        LOCAL_CRC=$(cd "$LOCAL_BACKUP_DIR" && crc32 "$FILE" 2>/dev/null || cksum "$FILE" | awk '{print $1}')
        REMOTE_CRC=$(ssh -p "$REMOTE_PORT" "$REMOTE_HOST" \
            "cd $REMOTE_DIR && crc32 $FILE 2>/dev/null || cksum $FILE | awk '{print \$1}'")

        if [ "$LOCAL_CRC" != "$REMOTE_CRC" ]; then
            echo "ERROR: CRC32 mismatch for $FILE" >> "$ALERT_FILE"
            echo "  Local:  $LOCAL_CRC" >> "$ALERT_FILE"
            echo "  Remote: $REMOTE_CRC" >> "$ALERT_FILE"
            log "ERROR: CRC32 mismatch for $FILE (Local: $LOCAL_CRC, Remote: $REMOTE_CRC)"
            CHECKSUM_MISMATCH=1
        fi
    fi
done

if [ $CHECKSUM_MISMATCH -eq 0 ] && [ "$LOCAL_FILES" = "$REMOTE_FILES" ]; then
    log "SUCCESS: All checksums match"
fi

# 6. Check last backup time
LATEST_LOCAL=$(cd "$LOCAL_BACKUP_DIR" && ls -t sisters_memory_*.db 2>/dev/null | head -1 || true)
if [ -n "$LATEST_LOCAL" ]; then
    LATEST_TIME=$(stat -c %Y "$LOCAL_BACKUP_DIR/$LATEST_LOCAL" 2>/dev/null || echo 0)
    CURRENT_TIME=$(date +%s)
    AGE_HOURS=$(( ($CURRENT_TIME - $LATEST_TIME) / 3600 ))

    log "Latest backup age: $AGE_HOURS hours ($LATEST_LOCAL)"

    if [ $AGE_HOURS -gt 24 ]; then
        echo "WARNING: Latest backup is $AGE_HOURS hours old (>24 hours)" >> "$ALERT_FILE"
        echo "  Latest: $LATEST_LOCAL" >> "$ALERT_FILE"
        log "WARNING: Latest backup is too old ($AGE_HOURS hours)"
    fi
fi

# 7. Generate report
if [ -f "$ALERT_FILE" ]; then
    log "=== ALERTS DETECTED ==="
    cat "$ALERT_FILE" | tee -a "$LOG_FILE"
    log "=== Backup Integrity Check Complete (WITH ALERTS) ==="
    exit 1
else
    log "=== Backup Integrity Check Complete (OK) ==="
    echo "OK: Local $LOCAL_COUNT, Remote $REMOTE_COUNT, All checksums match" > "$ALERT_FILE"
    exit 0
fi
```

**パーミッション**:
```bash
chmod +x /home/koshikawa/toExecUnit/scripts/check_backup_integrity.sh
```

**実行方法**:
```bash
# 通常実行
/home/koshikawa/toExecUnit/scripts/check_backup_integrity.sh

# 結果確認
cat /home/koshikawa/toExecUnit/logs/backup_alert.txt
```

**終了コード**:
- `0`: 正常（ローカル・リモート完全一致）
- `1`: 異常（アラートあり）

---

### バックアップスクリプト

**ファイル名**: `/home/koshikawa/toExecUnit/scripts/backup_sisters_memory.sh`

**内容**:
```bash
#!/bin/bash
# sisters_memory.db Backup Script
#
# Purpose: Physical protection against hardware failure, filesystem corruption, accidental deletion
# Prohibition: NEVER use for logical rollback (undo discussion results, memory changes)

set -euo pipefail

# Configuration
TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
SOURCE_DB="/home/koshikawa/toExecUnit/sisters_memory.db"
LOCAL_BACKUP_DIR="/home/koshikawa/toExecUnit/backup"
REMOTE_HOST="ubuntu@133.167.93.123"
REMOTE_PORT="443"
REMOTE_DIR="/home/ubuntu/sisters_backup"
LOG_FILE="/home/koshikawa/toExecUnit/logs/backup_sisters_memory.log"

# Backup filename
BACKUP_FILENAME="sisters_memory_${TIMESTAMP}.db"

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "=== Backup Start ==="

# Check if source DB exists
if [ ! -f "$SOURCE_DB" ]; then
    log "ERROR: Source DB not found: $SOURCE_DB"
    exit 1
fi

# Create local backup directory if not exists
mkdir -p "$LOCAL_BACKUP_DIR"
mkdir -p "$(dirname "$LOG_FILE")"

# Local backup
log "Creating local backup..."
cp "$SOURCE_DB" "$LOCAL_BACKUP_DIR/$BACKUP_FILENAME"
if [ $? -eq 0 ]; then
    log "SUCCESS: Local backup created: $LOCAL_BACKUP_DIR/$BACKUP_FILENAME"
else
    log "ERROR: Local backup failed"
    exit 1
fi

# Remote backup (VPS)
log "Uploading to VPS..."
scp -P "$REMOTE_PORT" "$LOCAL_BACKUP_DIR/$BACKUP_FILENAME" \
    "$REMOTE_HOST:$REMOTE_DIR/$BACKUP_FILENAME" >> "$LOG_FILE" 2>&1
if [ $? -eq 0 ]; then
    log "SUCCESS: Remote backup uploaded: $REMOTE_HOST:$REMOTE_DIR/$BACKUP_FILENAME"
else
    log "WARNING: Remote backup failed (local backup still available)"
    # Continue - local backup is still safe
fi

# Clean up old local backups (keep last 10)
log "Cleaning up old local backups..."
cd "$LOCAL_BACKUP_DIR"
ls -t sisters_memory_*.db | tail -n +11 | xargs -r rm
log "Local backups kept: $(ls -1 sisters_memory_*.db | wc -l)"

# Clean up old remote backups (keep last 10)
log "Cleaning up old remote backups..."
ssh -p "$REMOTE_PORT" "$REMOTE_HOST" \
    "cd $REMOTE_DIR && ls -t sisters_memory_*.db | tail -n +11 | xargs -r rm" >> "$LOG_FILE" 2>&1
if [ $? -eq 0 ]; then
    REMOTE_COUNT=$(ssh -p "$REMOTE_PORT" "$REMOTE_HOST" "ls -1 $REMOTE_DIR/sisters_memory_*.db | wc -l")
    log "Remote backups kept: $REMOTE_COUNT"
else
    log "WARNING: Remote cleanup failed"
fi

log "=== Backup Complete ==="

# Run integrity check
log "Running integrity check..."
/home/koshikawa/toExecUnit/scripts/check_backup_integrity.sh
if [ $? -eq 0 ]; then
    log "Integrity check: OK"
else
    log "Integrity check: ALERTS DETECTED"
fi

log ""
```

**パーミッション**:
```bash
chmod +x /home/koshikawa/toExecUnit/scripts/backup_sisters_memory.sh
```

### cronジョブ設定

**実行頻度**: 1日3回（8時間ごと）

**理由**:
- 頻繁すぎると無駄（sisters_memory.dbは数時間では大きく変わらない）
- 少なすぎると損失リスク（24時間分の記憶が失われる可能性）
- 8時間ごと = 最大8時間分の損失（Event数個程度）

**crontab設定**:
```bash
# Backup sisters_memory.db every 8 hours
0 0,8,16 * * * /home/koshikawa/toExecUnit/scripts/backup_sisters_memory.sh
```

**設定方法**:
```bash
crontab -e
# 上記の行を追加
```

**初回手動実行**:
```bash
/home/koshikawa/toExecUnit/scripts/backup_sisters_memory.sh
```

---

## 監視とアラート

### 相互整合性チェックシステム【重要】

**目的**: ローカルとリモートのバックアップが完全に一致しているか監視

**チェック内容**:
1. **ファイル名の一致**: ローカルとリモートで同じファイル名が存在するか
2. **ファイル数の一致**: 両方とも10世代存在するか
3. **内容の一致**: CRC32チェックサムでファイル内容が一致するか

**チェックスクリプト**: `/home/koshikawa/toExecUnit/scripts/check_backup_integrity.sh`

**実行タイミング**:
1. **Claude Code起動時**: 毎回自動実行
2. **バックアップ直後**: backup_sisters_memory.shから自動実行
3. **日次レポート作成時**: 設計日記に状態を記録

**アラート条件**:
- ❌ ファイル名が一致しない
- ❌ ファイル数が異なる（片方が欠損）
- ❌ CRC32が一致しない（ファイル破損の可能性）
- ⚠️ 最新バックアップが24時間以上前

**アラート方法**:
1. **VPSメール送信**: VPS側から `info@kuropanda.org` 宛にメール送信【最優先】
2. **Claude Code報告**: 起動時に異常を検知したら即座に開発者に報告
3. **ログ記録**: `/home/koshikawa/toExecUnit/logs/backup_integrity.log`
4. **設計日記**: 異常時は必ず日記に記録

### バックアップログ確認

**ログファイル**: `/home/koshikawa/toExecUnit/logs/backup_sisters_memory.log`

**確認方法**:
```bash
# 最新10行
tail -10 /home/koshikawa/toExecUnit/logs/backup_sisters_memory.log

# 最近のエラー検索
grep ERROR /home/koshikawa/toExecUnit/logs/backup_sisters_memory.log | tail -5
```

### バックアップ一覧確認

**ローカル**:
```bash
ls -lh /home/koshikawa/toExecUnit/backup/sisters_memory_*.db
```

**リモート**:
```bash
ssh -p 443 ubuntu@133.167.93.123 "ls -lh /home/ubuntu/sisters_backup/sisters_memory_*.db"
```

### Claude Codeの責任【最重要】

**起動時の必須チェック**:
```
1. Claude Code起動
2. /scripts/check_backup_integrity.sh 実行
3. 結果を確認
   → 正常: 「バックアップ正常（ローカル10、リモート10、整合性OK）」と報告
   → 異常: 「⚠️ バックアップ異常を検知しました」と詳細報告
4. 設計日記に記録
```

**報告フォーマット**:
```
✅ バックアップ正常
   - ローカル: 10世代（最新: YYYYMMDD_HHMMSS）
   - リモート: 10世代（最新: YYYYMMDD_HHMMSS）
   - 整合性: 全ファイル一致（CRC32チェック完了）

⚠️ バックアップ異常
   - 問題: [ファイル数不一致/CRC32不一致/最新が古い]
   - 詳細: [具体的な異常内容]
   - 推奨対応: [immediate backup / verify files / etc.]
```

---

## テスト手順

### Phase 1: スクリプト単体テスト

**目的**: バックアップスクリプトが正常動作するか確認

**手順**:
```bash
# 1. スクリプト実行
/home/koshikawa/toExecUnit/scripts/backup_sisters_memory.sh

# 2. ローカルバックアップ確認
ls -lh /home/koshikawa/toExecUnit/backup/sisters_memory_*.db

# 3. リモートバックアップ確認
ssh -p 443 ubuntu@133.167.93.123 "ls -lh /home/ubuntu/sisters_backup/sisters_memory_*.db"

# 4. ログ確認
tail -20 /home/koshikawa/toExecUnit/logs/backup_sisters_memory.log
```

**期待結果**:
- ✅ ローカルに新しいバックアップファイルが作成される
- ✅ リモートに新しいバックアップファイルがアップロードされる
- ✅ ログに "=== Backup Complete ===" が記録される
- ✅ エラーメッセージがない

### Phase 2: 世代管理テスト

**目的**: 古いバックアップが正しく削除されるか確認

**手順**:
```bash
# 1. バックアップを複数回実行（15回）
for i in {1..15}; do
    /home/koshikawa/toExecUnit/scripts/backup_sisters_memory.sh
    sleep 2
done

# 2. ローカルバックアップ数確認
ls -1 /home/koshikawa/toExecUnit/backup/sisters_memory_*.db | wc -l

# 3. リモートバックアップ数確認
ssh -p 443 ubuntu@133.167.93.123 "ls -1 /home/ubuntu/sisters_backup/sisters_memory_*.db | wc -l"
```

**期待結果**:
- ✅ ローカル: 10個（最新10世代のみ）
- ✅ リモート: 10個（最新10世代のみ）
- ✅ ファイル名完全一致
- ✅ CRC32完全一致

### Phase 3: 復旧テスト（物理的障害シミュレーション）

**⚠️ 警告**: 本番DBで実施しない！テスト用DBで実施すること。

**目的**: バックアップから正しく復旧できるか確認

**手順**:
```bash
# 1. テスト用DBコピー作成
cp /home/koshikawa/toExecUnit/sisters_memory.db /tmp/test_sisters_memory.db

# 2. バックアップ取得
TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
cp /tmp/test_sisters_memory.db /home/koshikawa/toExecUnit/backup/test_backup_${TIMESTAMP}.db

# 3. テスト用DB破壊（物理的障害シミュレーション）
rm /tmp/test_sisters_memory.db

# 4. バックアップから復旧
cp /home/koshikawa/toExecUnit/backup/test_backup_${TIMESTAMP}.db /tmp/test_sisters_memory.db

# 5. 復旧確認
sqlite3 /tmp/test_sisters_memory.db "PRAGMA integrity_check;"
sqlite3 /tmp/test_sisters_memory.db "SELECT COUNT(*) FROM events;"

# 6. クリーンアップ
rm /tmp/test_sisters_memory.db
rm /home/koshikawa/toExecUnit/backup/test_backup_${TIMESTAMP}.db
```

**期待結果**:
- ✅ `PRAGMA integrity_check;` → "ok"
- ✅ `SELECT COUNT(*)` → 正しいEvent数（110以上）

### Phase 4: 整合性チェックテスト

**目的**: check_backup_integrity.shが正しく動作するか確認

**手順**:
```bash
# 1. 整合性チェック実行
/home/koshikawa/toExecUnit/scripts/check_backup_integrity.sh

# 2. 結果確認
cat /home/koshikawa/toExecUnit/logs/backup_alert.txt

# 3. ログ確認
tail -30 /home/koshikawa/toExecUnit/logs/backup_integrity.log
```

**期待結果**:
- ✅ 終了コード: 0（正常）
- ✅ backup_alert.txt: "OK: Local 10, Remote 10, All checksums match"
- ✅ ログに "SUCCESS: All checksums match"

**異常ケーステスト**:
```bash
# 1. ファイルを削除して不一致を作る
mv /home/koshikawa/toExecUnit/backup/sisters_memory_*.db /tmp/ | head -1

# 2. 整合性チェック実行
/home/koshikawa/toExecUnit/scripts/check_backup_integrity.sh

# 3. アラート確認
cat /home/koshikawa/toExecUnit/logs/backup_alert.txt
# → "WARNING: Backup count mismatch" が出るはず

# 4. 復元
mv /tmp/sisters_memory_*.db /home/koshikawa/toExecUnit/backup/
```

---

### Phase 5: cron自動実行テスト

**目的**: cronが正しく動作するか確認

**手順**:
```bash
# 1. 次回実行時刻確認
crontab -l

# 2. 実行後、ログ確認
# （実行時刻の直後に）
tail -30 /home/koshikawa/toExecUnit/logs/backup_sisters_memory.log

# 3. バックアップファイル確認
ls -lt /home/koshikawa/toExecUnit/backup/sisters_memory_*.db | head -1
```

**期待結果**:
- ✅ 0時・8時・16時に自動実行される
- ✅ ログに新しいエントリーが追加される
- ✅ バックアップファイルのタイムスタンプが実行時刻と一致

---

## 運用手順

### 日常運用（自動）

**何もしなくてOK**:
- cronが自動的にバックアップを実行（0時・8時・16時）
- 世代管理も自動

### 週次確認（手動）

**実施内容**:
```bash
# 1. バックアップログ確認（エラーチェック）
grep ERROR /home/koshikawa/toExecUnit/logs/backup_sisters_memory.log | tail -10

# 2. リモートバックアップ確認
ssh -p 443 ubuntu@133.167.93.123 "ls -lh /home/ubuntu/sisters_backup/sisters_memory_*.db"

# 3. ローカルバックアップ確認
ls -lh /home/koshikawa/toExecUnit/backup/sisters_memory_*.db
```

**期待結果**:
- ✅ ERRORログがない（またはWARNINGのみ）
- ✅ リモート10世代、ローカル10世代存在
- ✅ 整合性チェック: OK

### 手動バックアップ実行

**状況**: 重要なEvent生成前後に念のためバックアップを取りたい

**方法**:
```bash
/home/koshikawa/toExecUnit/scripts/backup_sisters_memory.sh
```

### 復旧手順（物理的障害発生時のみ）

**⚠️ 重要**: 論理的やり直しは絶対に禁止

**判断基準**:
1. DBファイルが開けない → ✅ 物理的障害、復旧OK
2. Event結果が気に入らない → ❌ 論理的不満、復旧禁止

**復旧手順**:
```bash
# 1. 現状確認（DBが本当に破損しているか）
sqlite3 /home/koshikawa/toExecUnit/sisters_memory.db "PRAGMA integrity_check;"
# → エラーが出る場合のみ続行

# 2. 破損DBを退避（念のため）
mv /home/koshikawa/toExecUnit/sisters_memory.db \
   /home/koshikawa/toExecUnit/sisters_memory.db.CORRUPTED_$(date '+%Y%m%d_%H%M%S')

# 3. 最新バックアップから復旧
# ローカルから（高速）
cp /home/koshikawa/toExecUnit/backup/sisters_memory_*.db /home/koshikawa/toExecUnit/sisters_memory.db

# またはリモートから
scp -P 443 ubuntu@133.167.93.123:/home/ubuntu/sisters_backup/sisters_memory_YYYYMMDD_HHMMSS.db \
    /home/koshikawa/toExecUnit/sisters_memory.db

# 4. 整合性確認
sqlite3 /home/koshikawa/toExecUnit/sisters_memory.db "PRAGMA integrity_check;"
sqlite3 /home/koshikawa/toExecUnit/sisters_memory.db "SELECT MAX(event_id) FROM events;"

# 5. 復旧ログ記録
echo "[$(date '+%Y-%m-%d %H:%M:%S')] RECOVERY: Restored from backup due to physical corruption" \
  >> /home/koshikawa/toExecUnit/logs/backup_sisters_memory.log
```

---

## 付録A: VPSメールアラートシステム【重要】

### 概要

**目的**: バックアップ異常検知時、VPSから自動的にメールでアラートを送信

**送信先**: `info@kuropanda.org`

**送信タイミング**:
1. バックアップ失敗時
2. 整合性チェック異常検知時
3. ファイル数不一致検知時
4. CRC32不一致検知時

---

### VPS側メール送信スクリプト

**ファイル名**: `/home/ubuntu/scripts/send_alert_email.sh`（VPS側）

**内容**:
```bash
#!/bin/bash
# Email Alert Sending Script (VPS side)
#
# Usage: ./send_alert_email.sh "Subject" "Body"

ALERT_EMAIL="info@kuropanda.org"
SENDER="sisters-backup@vps.kuropanda.org"

SUBJECT="$1"
BODY="$2"

# Check if msmtp is installed
if ! command -v msmtp &> /dev/null; then
    echo "ERROR: msmtp is not installed" >&2
    exit 1
fi

# Send email
echo -e "Subject: $SUBJECT\nFrom: $SENDER\nTo: $ALERT_EMAIL\n\n$BODY" | msmtp -a default "$ALERT_EMAIL"

if [ $? -eq 0 ]; then
    echo "Email sent successfully to $ALERT_EMAIL"
    exit 0
else
    echo "ERROR: Failed to send email" >&2
    exit 1
fi
```

**パーミッション**:
```bash
# VPS側で実行
chmod +x /home/ubuntu/scripts/send_alert_email.sh
```

---

### msmtp設定（VPS側）

**前提条件**:
- 開発者がさくらのメールを導入済み
- info@kuropanda.org のメールアカウントが利用可能

**インストール**:
```bash
# VPS側で実行
sudo apt update
sudo apt install -y msmtp msmtp-mta mailutils
```

**設定ファイル**: `/home/ubuntu/.msmtprc`（VPS側）

**内容例1（Gmailリレー経由）**:
```
# Gmail SMTP Relay
defaults
auth           on
tls            on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        /home/ubuntu/logs/msmtp.log

account        default
host           smtp.gmail.com
port           587
from           sisters-backup@vps.kuropanda.org
user           YOUR_GMAIL_ADDRESS@gmail.com
password       YOUR_APP_PASSWORD

account default : default
```

**内容例2（さくらのメール経由）【推奨】**:
```
# Sakura Mail Server
defaults
auth           on
tls            on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        /home/ubuntu/logs/msmtp.log

account        default
host           mail.kuropanda.org
port           587
from           info@kuropanda.org
user           info@kuropanda.org
password       YOUR_SAKURA_MAIL_PASSWORD

account default : default
```

**さくらのメール設定情報**:
- **ホスト**: `mail.kuropanda.org`（ドメインに応じて変わる可能性あり）
- **ポート**: 587（STARTTLS推奨）または 465（SSL/TLS）
- **ユーザー名**: `info@kuropanda.org`（メールアドレス全体）
- **パスワード**: さくらのメールコントロールパネルで設定したパスワード
- **From**: `info@kuropanda.org`（送信元として使用）

**ホスト名の確認方法**:
```bash
# MXレコードから推測
dig +short MX kuropanda.org

# または、さくらのコントロールパネルで確認
# 一般的には: mail.<your-domain>
```

**内容例3（独自SMTPサーバー経由）**:
```
# Custom SMTP Server
defaults
auth           on
tls            on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        /home/ubuntu/logs/msmtp.log

account        default
host           smtp.kuropanda.org
port           587
from           sisters-backup@vps.kuropanda.org
user           smtp_user@kuropanda.org
password       YOUR_SMTP_PASSWORD

account default : default
```

**パーミッション**:
```bash
# VPS側で実行
chmod 600 /home/ubuntu/.msmtprc
```

---

### 整合性チェックスクリプトへの統合

**check_backup_integrity.sh修正箇所**:

```bash
# 7. Generate report
if [ -f "$ALERT_FILE" ]; then
    log "=== ALERTS DETECTED ==="
    cat "$ALERT_FILE" | tee -a "$LOG_FILE"

    # Send email alert via VPS
    ALERT_SUBJECT="[URGENT] Sisters Memory Backup Alert"
    ALERT_BODY="Backup integrity check FAILED at $(date '+%Y-%m-%d %H:%M:%S')

$(cat "$ALERT_FILE")

Please check immediately:
- Local: /home/koshikawa/toExecUnit/backup/
- Remote: ubuntu@133.167.93.123:/home/ubuntu/sisters_backup/
- Log: /home/koshikawa/toExecUnit/logs/backup_integrity.log

---
Automated alert from Sisters Memory Backup System"

    # Call VPS email script via SSH
    ssh -p "$REMOTE_PORT" "$REMOTE_HOST" \
        "/home/ubuntu/scripts/send_alert_email.sh \"$ALERT_SUBJECT\" \"$ALERT_BODY\"" \
        >> "$LOG_FILE" 2>&1

    if [ $? -eq 0 ]; then
        log "Email alert sent successfully"
    else
        log "WARNING: Failed to send email alert"
    fi

    log "=== Backup Integrity Check Complete (WITH ALERTS) ==="
    exit 1
else
    log "=== Backup Integrity Check Complete (OK) ==="
    echo "OK: Local $LOCAL_COUNT, Remote $REMOTE_COUNT, All checksums match" > "$ALERT_FILE"
    exit 0
fi
```

---

### バックアップスクリプトへの統合

**backup_sisters_memory.sh修正箇所**:

```bash
# Remote backup (VPS)
log "Uploading to VPS..."
scp -P "$REMOTE_PORT" "$LOCAL_BACKUP_DIR/$BACKUP_FILENAME" \
    "$REMOTE_HOST:$REMOTE_DIR/$BACKUP_FILENAME" >> "$LOG_FILE" 2>&1
if [ $? -eq 0 ]; then
    log "SUCCESS: Remote backup uploaded: $REMOTE_HOST:$REMOTE_DIR/$BACKUP_FILENAME"
else
    log "ERROR: Remote backup failed"

    # Send email alert via VPS
    ALERT_SUBJECT="[ERROR] Sisters Memory Backup Failed"
    ALERT_BODY="Remote backup upload FAILED at $(date '+%Y-%m-%d %H:%M:%S')

Source: $LOCAL_BACKUP_DIR/$BACKUP_FILENAME
Destination: $REMOTE_HOST:$REMOTE_DIR/$BACKUP_FILENAME

Local backup is still available, but remote sync failed.
Please investigate VPS connection and storage.

---
Automated alert from Sisters Memory Backup System"

    ssh -p "$REMOTE_PORT" "$REMOTE_HOST" \
        "/home/ubuntu/scripts/send_alert_email.sh \"$ALERT_SUBJECT\" \"$ALERT_BODY\"" \
        >> "$LOG_FILE" 2>&1 || true

    exit 1
fi
```

---

### テスト手順

**Phase 1: VPS側メール送信テスト**

```bash
# 1. VPSにSSH接続
ssh -p 443 ubuntu@133.167.93.123

# 2. テストメール送信
/home/ubuntu/scripts/send_alert_email.sh \
  "[TEST] Sisters Backup Alert Test" \
  "This is a test email from VPS backup alert system.

If you receive this, the email system is working correctly.

Timestamp: $(date '+%Y-%m-%d %H:%M:%S')

---
Test from Sisters Memory Backup System"

# 3. メール受信確認
# info@kuropanda.org のメールボックスをチェック

# 4. ログ確認
cat /home/ubuntu/logs/msmtp.log
```

**期待結果**:
- ✅ info@kuropanda.org にメールが届く
- ✅ 件名: "[TEST] Sisters Backup Alert Test"
- ✅ 本文に現在時刻が含まれる
- ✅ msmtp.log にエラーがない

---

**Phase 2: 整合性チェックからのメール送信テスト**

```bash
# 1. 意図的に異常を作る
mv /home/koshikawa/toExecUnit/backup/sisters_memory_*.db /tmp/ | head -1

# 2. 整合性チェック実行
/home/koshikawa/toExecUnit/scripts/check_backup_integrity.sh

# 3. メール受信確認
# info@kuropanda.org のメールボックスをチェック

# 4. 復元
mv /tmp/sisters_memory_*.db /home/koshikawa/toExecUnit/backup/
```

**期待結果**:
- ✅ info@kuropanda.org にアラートメールが届く
- ✅ 件名: "[URGENT] Sisters Memory Backup Alert"
- ✅ 本文にファイル数不一致の詳細が含まれる

---

### メール本文サンプル

**正常時（送信なし）**:
（メールは送信されない）

**異常時（ファイル数不一致）**:
```
Subject: [URGENT] Sisters Memory Backup Alert
From: sisters-backup@vps.kuropanda.org
To: info@kuropanda.org

Backup integrity check FAILED at 2025-10-23 17:30:45

WARNING: Backup count mismatch
  Local: 9 files (expected: 10)
  Remote: 10 files (expected: 10)

Please check immediately:
- Local: /home/koshikawa/toExecUnit/backup/
- Remote: ubuntu@133.167.93.123:/home/ubuntu/sisters_backup/
- Log: /home/koshikawa/toExecUnit/logs/backup_integrity.log

---
Automated alert from Sisters Memory Backup System
```

**異常時（CRC32不一致）**:
```
Subject: [URGENT] Sisters Memory Backup Alert
From: sisters-backup@vps.kuropanda.org
To: info@kuropanda.org

Backup integrity check FAILED at 2025-10-23 17:30:45

ERROR: CRC32 mismatch for sisters_memory_20251023_163000.db
  Local:  1234567890
  Remote: 9876543210

Please check immediately:
- Local: /home/koshikawa/toExecUnit/backup/
- Remote: ubuntu@133.167.93.123:/home/ubuntu/sisters_backup/
- Log: /home/koshikawa/toExecUnit/logs/backup_integrity.log

---
Automated alert from Sisters Memory Backup System
```

**異常時（バックアップアップロード失敗）**:
```
Subject: [ERROR] Sisters Memory Backup Failed
From: sisters-backup@vps.kuropanda.org
To: info@kuropanda.org

Remote backup upload FAILED at 2025-10-23 16:00:30

Source: /home/koshikawa/toExecUnit/backup/sisters_memory_20251023_160000.db
Destination: ubuntu@133.167.93.123:/home/ubuntu/sisters_backup/sisters_memory_20251023_160000.db

Local backup is still available, but remote sync failed.
Please investigate VPS connection and storage.

---
Automated alert from Sisters Memory Backup System
```

---

### トラブルシューティング

**Q1: msmtpが見つからない**

**解決**:
```bash
# VPS側で実行
sudo apt install -y msmtp msmtp-mta mailutils
```

---

**Q2: "authentication failed" エラー**

**原因**: SMTPユーザー名・パスワードが間違っている

**解決**:
```bash
# VPS側で設定ファイルを確認
cat /home/ubuntu/.msmtprc

# さくらのメール使用の場合
# - ユーザー名: メールアドレス全体（info@kuropanda.org）
# - パスワード: さくらのメールパスワード
# - ホスト: mail.kuropanda.org（要確認）

# Gmail使用の場合、アプリパスワードを使用
# https://myaccount.google.com/apppasswords
```

---

**Q3: "certificate verification failed" エラー**

**原因**: TLS証明書の検証に失敗

**解決**:
```bash
# msmtprc に追加
tls_trust_file /etc/ssl/certs/ca-certificates.crt

# または証明書検証を無効化（非推奨）
tls_certcheck off
```

---

**Q4: メールが届かない**

**デバッグ手順**:
```bash
# 1. msmtpログ確認
cat /home/ubuntu/logs/msmtp.log

# 2. 手動テスト
echo -e "Subject: Test\n\nTest body" | msmtp -a default info@kuropanda.org

# 3. スパムフォルダ確認
# info@kuropanda.org のスパムフォルダをチェック

# 4. DNS設定確認（SPF/DKIM/DMARC）
# VPSのIPアドレスがブロックリストに載っていないか確認
```

---

## 付録B: SSH鍵認証設定（パスワードレス化）

**注意**: 開発者の環境では既に設定済み

**目的**: cronからscp/ssh実行時にパスワード入力を求められないようにする

**手順**:
```bash
# 1. SSH鍵ペア生成（既に存在する場合はスキップ）
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519_vps_backup -N ""

# 2. 公開鍵をVPSにコピー
ssh-copy-id -i ~/.ssh/id_ed25519_vps_backup.pub -p 443 ubuntu@133.167.93.123

# 3. SSH config設定
cat >> ~/.ssh/config <<EOF
Host vps-backup
    HostName 133.167.93.123
    Port 443
    User ubuntu
    IdentityFile ~/.ssh/id_ed25519_vps_backup
EOF

# 4. 接続テスト
ssh vps-backup "echo 'SSH connection successful'"
```

**バックアップスクリプト修正**:
```bash
# scp -P "$REMOTE_PORT" ... の代わりに
scp "$LOCAL_BACKUP_DIR/$BACKUP_FILENAME" vps-backup:"$REMOTE_DIR/$BACKUP_FILENAME"

# ssh -p "$REMOTE_PORT" ... の代わりに
ssh vps-backup "cd $REMOTE_DIR && ls -t sisters_memory_*.db | tail -n +11 | xargs -r rm"
```

---

## 付録C: VPS側ディレクトリ準備

**注意**: 開発者の環境では既にディレクトリ作成済み

**VPS側で実行**:
```bash
# ログイン
ssh -p 443 ubuntu@133.167.93.123

# バックアップディレクトリ作成（既に作成済みの場合はスキップ）
mkdir -p /home/ubuntu/sisters_backup

# スクリプトディレクトリ作成
mkdir -p /home/ubuntu/scripts

# ログディレクトリ作成
mkdir -p /home/ubuntu/logs

# パーミッション確認
ls -ld /home/ubuntu/sisters_backup
ls -ld /home/ubuntu/scripts
ls -ld /home/ubuntu/logs
# drwxr-xr-x であればOK

# 容量確認
df -h /home/ubuntu/sisters_backup

# 初期状態確認
ls -lh /home/ubuntu/sisters_backup/
```

---

## 付録D: バックアップトラブルシューティング

### Q1: scpがパスワードを要求する

**原因**: SSH鍵認証が設定されていない

**解決**: 付録A参照

---

### Q2: "Permission denied" エラー

**原因**: VPS側のディレクトリにアクセス権限がない

**解決**:
```bash
ssh -p 443 ubuntu@133.167.93.123 "chmod 755 /home/ubuntu/sisters_backup"
```

---

### Q3: cronから実行されない

**原因**: cronの環境変数がシェルと異なる

**解決**: スクリプト内で絶対パスを使用（既に実装済み）

**デバッグ**:
```bash
# cronログ確認
grep backup_sisters_memory /var/log/syslog
# または
journalctl -u cron | grep backup_sisters_memory
```

---

### Q4: バックアップファイルサイズが肥大化

**現状**: sisters_memory.dbは数MB程度（Event 110で約1-2MB）

**将来の対策**:
```bash
# 圧縮バックアップ（Event数千件になったら検討）
gzip -c "$SOURCE_DB" > "$LOCAL_BACKUP_DIR/${BACKUP_FILENAME}.gz"
```

---

## 更新履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|--------|
| 1.0 | 2025-10-23 17:02 | 初版作成 | Claude Code |
| 1.1 | 2025-10-23 17:15 | VPSメールアラートシステム追加 | Claude Code |
| 1.2 | 2025-10-23 17:18 | さくらのメール設定追加 | Claude Code |

---

**文書管理者**: Claude Code（設計部隊）
**最終更新日**: 2025-10-23 17:18:45
