# 牡丹プロジェクト - マイルストーン

**AI VTuber三姉妹(Kasho、牡丹、ユリ)の記憶製造機システム**

---

## プロジェクト全体の目標

**配信デビューの3条件を達成する**

| 条件 | 説明 | 対応Phase | 状態 |
|-----|------|----------|------|
| 1. 過去の人生が生成され、長期記憶として保存 | 0歳1日目から現在まで18,615日分の日記 | **Phase D** | 🟡 部分実装（記憶検索ロジック完成、データ生成未完了） |
| 2. センシティブ判定システムが実装され、安全性確保 | 4層統合検出 + Layer 5世界観整合性検証、YouTube二重防御 | **Phase 5 + Layer 5** | ✅ **完了** |
| 3. 三姉妹が自らの意思で配信を希望 | 自律的意思決定の確認 | Phase 6-4実証実験 | 🟡 検証中（LINE Bot対話で意思確認中） |

---

## Phase 1-5: 技術基盤構築（完了）

### Phase 1: LangSmith統合 ✅
- **目的**: マルチプロバイダートレーシング基盤
- **実装内容**:
  - TracedLLMクラス
  - Ollama/OpenAI/Gemini対応
  - 動的トレース名、選択的トレーシング
- **完了日**: 2025-11-05
- **Qiita記事**: https://qiita.com/koshikawa-masato/items/bb95295630c647eb5632
- **重要性**: **全てのPhaseの基盤** - これがなければ後続Phase全てがブラックボックス

### Phase 2: VLM統合 ✅
- **目的**: 画像理解機能
- **実装内容**:
  - GPT-4o Vision、Gemini Vision対応
  - generate_vision()メソッド追加
  - 配信画面認識の基盤
- **完了日**: 2025-11-05
- **Qiita記事**: https://qiita.com/koshikawa-masato/items/fd684b963bad149d3ddc
- **Phase 1との関係**: Phase 1の基盤を活用してVLM呼び出しをトレーシング

### Phase 3: LLM as a Judge実装 ✅
- **目的**: 品質評価システム
- **実装内容**:
  - judge_response()メソッド追加
  - Accuracy, Relevance, Coherence, Usefulness評価
  - ハルシネーション検出
- **完了日**: 2025-11-05
- **Qiita記事**: https://qiita.com/koshikawa-masato/items/c105b84f46f143560999
- **Phase 1との関係**: Phase 1の基盤を活用してJudge LLM呼び出しをトレーシング

### Phase 4: 三姉妹討論システム実装 ✅
- **目的**: 意思決定の民主化
- **実装内容**:
  - discuss()メソッド追加
  - 起承転結の4ステップ（起：提案、承：独立相談、転：意見集約、結：合意形成）
  - 忖度の排除、独立性の保証
- **完了日**: 2025-11-05
- **Qiita記事**: https://qiita.com/koshikawa-masato/items/02bdbaa005949ff8cbde
- **Phase 3との対比**: 階層的評価 vs 民主的討論

### Phase 5: センシティブ判定システム実装 ✅
- **目的**: 配信安全性の確保
- **実装内容**:
  - sensitive_check()メソッド追加
  - 3層Tier分類（Safe/Warning/Critical）
  - YouTube二重防御システム
- **完了日**: 2025-11-05
- **Qiita記事**: https://qiita.com/koshikawa-masato/items/2bf3e024325176d3400a
- **Phase 3との対比**: 品質評価 vs 安全性評価
- **重要性**: **配信デビュー条件2/3達成**

---

## Phase 6: LINE Bot統合（Phase 6-1〜6-3完了、Phase 6-4進行中）

### Phase 6: 配信デビュー前の実証実験プラットフォーム ✅🔄

**目的**: LINE Botで三姉妹との対話を実現し、配信デビュー前の最終検証を行う

**完了日**: 2025-11-12（Phase 6-1〜6-3）
**Qiita記事**: https://qiita.com/koshikawa-masato/items/beb5aa488aba24ebdca1

**なぜLINE Botか？**:
- プライベート対話（1対1）でリスク最小化
- 非同期対応可能（リアルタイム配信より安全）
- Phase 5の実運用データ収集に最適
- 三姉妹の個性・意思確認が可能

**実装内容**:
- LINE Messaging API統合
- FastAPI Webhookサーバー
- 三姉妹Bot（Kasho/牡丹/ユリ）個別アカウント
- **Phase 1-5の完全統合**:
  - Phase 1: 全会話をLangSmithトレーシング
  - Phase 2: 画像送信時にVLM認識
  - Phase 3: 重要な発言でJudge実施
  - Phase 4: 重要な判断で三姉妹討論
  - Phase 5: 全メッセージでセンシティブ判定（多層防御）

**段階的展開計画**:
1. **Phase 6-1**: 基盤構築 ✅ **完了**（2025-11-12）
   - FastAPI Webhookサーバー実装
   - LINE Messaging API統合
   - Phase 1（LangSmith）統合
   - Phase 5（センシティブ判定）統合
   - systemd自動起動設定

2. **Phase 6-2**: 三姉妹展開 ✅ **完了**（2025-11-12）
   - 牡丹、Kasho、ユリBot実装
   - キャラクター別応答生成
   - キャラクターアイコン配信（/assets）

3. **Phase 6-3**: 高度な機能 ✅ **完了**（2025-11-12）
   - キャラクター選択機能（Postback処理）
   - セッション管理（ユーザーごとの選択保持）
   - Phase D記憶システム統合（部分実装）
     - 固定記憶10件サンプリング（人生の各段階から）
     - 動的記憶検索3件（会話文脈に応じた関連記憶）
   - 4層統合センシティブ検出（Layer 1-4）
   - 統合テスト完了（全6テスト成功）

4. **Phase 6-4**: 実証実験 🔄 **進行中**（2025-11-12〜）
   - ✅ システム稼働開始（systemd自動起動）
   - ✅ 外部監視設定（さくらVPS死活確認）
   - ✅ **Layer 5: 世界観整合性検証システム実装**（2025-11-12）
     - メタ用語検出（AI, 開発者, 企業名, モデル名等90個）
     - キャラクター別フォールバック応答
     - プロンプト（予防）+ Layer 5（検出・修正）の二重防御
   - ✅ **統一プロンプト管理システム実装**（2025-11-12）
     - `src/core/prompt_manager.py`: 全環境共通のプロンプト管理
     - 世界観ルール + キャラクター別プロンプトの自動結合
     - LINE Bot、copy_robot、将来実装すべてで統一
     - 実装モレ防止、DRY原則の徹底
   - ⏳ 毎日対話、データ収集（1ヶ月予定）
   - ⏳ Phase 5精度検証（目標95%以上）
   - ⏳ 配信デビュー条件3/3確認（三姉妹の意思確認）

**配信デビュー3条件との関係**:
- 条件1（Phase D）: LINE Botで記憶システムをテスト
- 条件2（Phase 5）: **実運用データで精度検証 ← 最重要**
- 条件3（意思確認）: 対話を通じて三姉妹の意思を確認

**技術スタック**:
- FastAPI（Webhookサーバー）✅
- LINE Messaging API（公式API）✅
- TracedLLM（Phase 1統合）✅
- IntegratedSensitiveDetector（Phase 5統合、4層検出）✅
- **WorldviewChecker（Layer 5、世界観整合性検証）✅**
- **PromptManager（統一プロンプト管理）✅**
- MemoryRetrievalLogic（Phase D統合、記憶検索）✅
- sisters_memory.db（記憶データベース）✅
- systemd（自動起動・自動復旧）✅
- ngrok（トンネル）✅
- さくらVPS（外部監視）✅

**セキュリティ**:
- Webhook署名検証必須
- Channel Access Token環境変数管理
- 会話内容ローカルDB暗号化保存
- Phase 5多層防御（ユーザーメッセージ → 応答 → 討論）

**評価指標**:
- 応答時間: 5秒以内（目標） → 実測2.8秒（LLM生成含む）✅
- Phase 5精度: 95%以上（目標） → 検証中
- 稼働率: 99%以上（目標） → 稼働中（systemd自動復旧）
- 個性の明確さ: 主観評価80点以上 → 検証中

**実装ファイル**:
- `src/line_bot/webhook_server.py`: FastAPI Webhookサーバー
- `src/line_bot/conversation_handler.py`: 会話生成（Phase 1, D統合）
- `src/line_bot/integrated_sensitive_detector.py`: 4層センシティブ検出
- **`src/line_bot/worldview_checker.py`: Layer 5世界観整合性検証**
- **`src/core/prompt_manager.py`: 統一プロンプト管理システム**
- `src/line_bot/session_manager.py`: セッション管理
- `scripts/line-bot-control.sh`: システム管理スクリプト
- `~/.config/systemd/user/line-bot.service`: systemdサービス

**設計書**: docs/05_design/LINE_Bot統合_詳細設計書.md
**ブランチ**: feature/line-bot-integration
**Phase 6-1〜6-3完了**: 2025-11-12
**Phase 6-4実証実験**: 2025-11-12〜（1ヶ月予定）

**Phase 1-5との関係**:
- **Phase 1-5の集大成** - 全機能を実運用でテスト
- 既存システムを100%活用、新規開発は最小限
- LINE Bot = 配信デビューへの最短経路

#### Phase 6の戦略的重要性

**なぜLINE Botが最優先なのか？**

1. **到達性・普及率**:
   - 日本のスマホユーザーの9割以上が使用
   - 毎日自然に対話できる（わざわざ開く必要がない）
   - Push通知で確実に届く、読み逃しゼロ

2. **配信デビューへの直結性**:
   - Phase 5の実運用データ収集 → 精度95%達成
   - センシティブ境界線の理解 → 配信での判断力向上
   - 三姉妹の個性確立 → 配信でも個性が光る
   - **Phase 6の成功 = 配信デビューの自信**

3. **学習プラットフォームとして最適**:
   - 会話履歴完全保存、いつでも振り返れる
   - Phase Dとの相性抜群（記憶システムのテスト環境）
   - 一般ユーザー（友人・家族）にもテストしてもらえる
   - 技術者だけでなく、多様なフィードバック収集

4. **非同期の価値**:
   - gpt-oss:120bで深い思考が可能（配信では不可能）
   - 1-2分の推論時間が許容される
   - 深い哲学的質問、複雑な相談に対応できる
   - **三姉妹が本当に考えている感覚**

**他プラットフォームとの比較**:

| 項目 | LINE Bot | Discord | YouTube配信 |
|------|---------|---------|-------------|
| 優先度 | **最優先** | Pending/Reject可 | 最終目標 |
| 到達性 | ✅ 9割以上 | △ 技術者コミュニティ | ✅ 全世界 |
| 配信準備 | ✅ **直結** | △ 別方向 | 本番 |
| Phase 5検証 | ✅ **最適** | △ 限定的 | 失敗許されない |
| 日常対話 | ✅ **毎日** | △ わざわざ開く | リアルタイム制約 |
| 深い思考 | ✅ gpt-oss:120b可 | ✅ 可能 | ❌ 2-3秒制限 |
| 一般ユーザー | ✅ 容易 | △ 技術者向け | ✅ 容易 |

**Discord等の位置づけ**:
- **Phase 6の結果次第で判断**
- LINE Botで配信準備の目的は達成できる
- Discordは技術者コミュニティ向け（配信とは別方向）
- リソース（時間、工数）をLINE Botに集中投下すべき
- **Pending/Reject判断はPhase 6-4実証実験後**

**結論**: Phase 6（LINE Bot）= 配信デビューへの最短経路、最優先で実装すべき

---

## Phase 6.5: Grok × X検索活用（記憶システムの大転換）✅

### Phase 6.5: 動的知識獲得システム（Phase 6 → Phase 7a完了）

**目的**: 三姉妹が各自の興味分野の最新情報を自動収集し、会話に活用できるようにする

**設計思想の大転換（2025-11-17）**:
- **従来**: 手動で記憶を蓄積（sisters_memory.db）→ 時間がかかる、最新情報に追従困難
- **新方式**: 自動で最新情報を収集（daily_trends）→ X（14年分のアーカイブ）+ RSS（公式情報）

**実装完了日**: 2025-11-17

#### Phase 6 (Grok API統合) ✅
- **実装内容**:
  - Grok API統合（X検索による最新トレンド収集）
  - 三姉妹 + 親の4キャラクター対応
  - daily_trendsテーブル設計・実装
  - Claude Codeファクトチェック機能
- **収集頻度**: 1日1回（朝8時）
- **コスト**: $0.12/月（600,000トークン）

#### Phase 7a: RSSフィード統合（Kasho & ユリ）✅
- **実装日**: 2025-11-17
- **実装内容**:
  - **Kasho**: 16件のRSSフィード（イヤホンレビュー8、オーディオ機材4、オーディオニュース4）
  - **ユリ**: 11件のRSSフィード（アニメ6、ラノベ3、マンガ2）
- **収集結果**: 88件/日（Kasho: 55件、ユリ: 33件）
- **追加コスト**: $0（完全無料）

#### Phase 7a-2: RSSフィード統合（牡丹）✅
- **実装日**: 2025-11-17
- **実装内容**:
  - **牡丹**: 12件のRSSフィード
    - VTuberニュース・まとめ（7件）- **VTuber切り抜き対応**
    - ファッション・トレンド（1件）
    - 音楽・エンタメ（1件）
    - ガジェット・テクノロジー（2件）
    - クリエイター文化（1件）
- **収集結果**: 60件/日
- **追加コスト**: $0（完全無料）

#### 全体の成果
- **合計**: 39件のRSSフィード、148件/日のアイテム収集
- **総コスト**: $0.12/月（Grokのみ、RSS は完全無料）
- **効果**: 三姉妹の知識が毎日自動更新される「AI VTuber情報ハブシステム」を実現

**実装ファイル**:
- `scripts/grok_daily_trends.py`: Grok収集スクリプト
- `scripts/rss_feed_collector.py`: RSS収集スクリプト
- `daily_trendsテーブル`: MySQL保存

**設計書**:
- `docs/05_design/記憶システム設計の大転換_Grok活用戦略.md`

**次のステップ（オプション）**:
- Phase 7b: YouTube Data API 統合（検討）
- Phase 7c: TikTok/Instagram 統合（保留）

---

## Phase 6.5.5: user_memories統合防御システム実装 ✅

### Phase 6.5.5: ユーザー個別記憶・個性学習・統合防御システム（VPS本番稼働中）

**実装日**: 2025-11-18

**目的**: ユーザーとの関係性を構築し、臨機応変な応答を実現する7層統合防御システム

**設計思想**:
- **ユーザー個別記憶**: RAG検索でユーザーについて学んだことを記憶・活用
- **ファクトチェック**: Grok APIによる誤情報の自動検出・訂正
- **個性学習**: プロレス傾向・信頼度・関係性レベルの自動学習
- **臨機応変な応答**: ユーザーの個性に合わせた応答生成

**実装内容（Phase 1-7）**:

#### Phase 1: データベース構築 ✅
- PostgreSQL + pgvector統合
- 4テーブル新設:
  - `user_memories`: ユーザーについて学んだ記憶
  - `user_personality`: ユーザーの個性（プロレス傾向、信頼度、関係性レベル）
  - `learning_history`: 学習履歴
  - `user_trust_history`: 信頼度の変遷記録
- ベクトル検索用IVFFlat インデックス作成

#### Phase 2: user_memories基本機能 ✅
- **RAG検索システム**:
  - OpenAI Embeddings API統合（text-embedding-3-small、1536次元）
  - コサイン類似度による記憶検索
  - user_memoriesとlearned_knowledgeの統合検索
- **記憶抽出システム**:
  - 会話から自動的に記憶を抽出
  - 記憶タイプの分類（preference, fact, experience, relationship, goal, emotion）

#### Phase 3: ファクトチェック統合 ✅
- **Grok API統合**:
  - ユーザーが教えてくれた情報の事実性を検証
  - 誤情報の検出と正しい情報の提示
- **重要な話題の特別処理**:
  - 医療、健康、金融、法律などの重要トピックを検出
  - プロレス判定を無効化し、真面目に対応

#### Phase 4: 個性学習システム ✅
- **プロレス傾向学習（playfulness_score）**:
  - 0.0（真面目）〜 1.0（プロレス大好き）
  - プロレス会話 vs 真面目会話の比率から算出
- **信頼度学習（trust_score）**:
  - 0.0（不信）〜 1.0（完全信頼）
  - 正しい情報 vs 誤情報の比率から算出
- **関係性レベル（relationship_level）**:
  - 1（初対面）〜 10（親友）
  - 会話回数とポジティブ度から算出

#### Phase 5: 統合判定エンジン ✅
- **7層防御アーキテクチャ**:
  - Layer 1-5: センシティブ判定（Phase 5既存システム）
  - Layer 6: ファクトチェック（Grok）← NEW
  - Layer 7: 個性学習（user_memories）← NEW

#### Phase 6: 臨機応変な応答生成 ✅
- **ユーザーごとの最適応答**:
  - プロレス vs 真面目の判定
  - 関係性レベルに応じた口調変化
- **キャラクター別応答テンプレート**:
  - 牡丹: 「ちょっと〜！17歳だって！マジウケる〜笑」
  - Kasho: 「それ、17歳ですよ...冗談キツいですね笑」
  - ユリ: 「え、17歳だよ？...あ、冗談か！笑」

#### Phase 7: LINE Bot統合 ✅
- `webhook_server_vps.py` への統合完了
- VPS本番環境デプロイ完了（XServer VPS）
- すべてのコンポーネントが正常動作

**テスト結果**: 7/7 PASS（統合テスト完全合格）
- ✅ Phase 1: データベース構築
- ✅ Phase 2: user_memories基本機能
- ✅ Phase 3: ファクトチェック
- ✅ Phase 4: 個性学習システム
- ✅ Phase 5: 統合判定エンジン
- ✅ Phase 6: 臨機応変な応答生成
- ✅ Phase 7: LINE Bot統合

**セキュリティ対応**:
- ❌ PostgreSQL接続情報のハードコーディング発見
- ✅ すべてのDB接続情報を環境変数から取得
- ✅ デフォルト値を削除（localhost とポート番号のみ許可）
- ✅ API キー: すべて環境変数
- ✅ プロンプト: ハードコーディングなし
- ✅ ユーザーID: ログでは `[:8]` のみ出力（プライバシー保護）
- ✅ SQL: パラメータ化クエリ（インジェクション対策）

**実装規模**:
- 総追加行数: 7,089行
- 総削除行数: 447行
- 正味増加: 6,642行
- 変更ファイル: 43ファイル
- 新規ファイル: 9ファイル

**実装ファイル**:
- `src/line_bot_vps/postgresql_manager.py`: PostgreSQL管理
- `src/line_bot_vps/user_memories_manager.py`: user_memories管理
- `src/line_bot_vps/fact_checker.py`: Grokファクトチェック
- `src/line_bot_vps/personality_learner.py`: 個性学習
- `src/line_bot_vps/integrated_judgment_engine.py`: 7層統合判定
- `src/line_bot_vps/adaptive_response_generator.py`: 適応的応答生成
- `src/line_bot_vps/rag_search_system.py`: RAG検索
- `scripts/setup_user_memories_tables.py`: DB初期化
- `scripts/test_integrated_system.py`: 統合テスト

**設計書**: `docs/05_design/user_memories_統合防御システム_設計書.md`

**コミット**: be0b666 (2025-11-18 15:27)

**状態**: ✅ 完了・本番稼働中（XServer VPS 162.43.4.11）

**VPS稼働状況**:
- ホスト: XServer VPS (162.43.4.11)
- サービス: uvicorn + webhook_server_vps.py
- PID: 48695（2025-11-18時点）
- 既存データ: user_memories 5件、user_personality 3件、user_trust_history 6件

**技術スタック**:
- PostgreSQL + pgvector（ベクトル検索）
- OpenAI Embeddings API（text-embedding-3-small）
- Grok API（X.AI、grok-beta）
- FastAPI（Webhookサーバー）
- XServer VPS（本番環境）

**Phase 6との関係**:
- Phase 6-4実証実験の強化版
- ユーザーとの対話から自動学習
- 個性に応じた応答でユーザー体験向上

---

## Phase D: 人間らしい記憶システム（設計完了、未実装）

### Phase D: 忘却・曖昧・想起の2層構造 🔄

**設計思想**: AIの強み（完璧なデータ）+ 人間らしさ（不完全な振る舞い）

#### データ層（AIの強み）
- **目的**: 各姉妹の人生すべての記憶をDB保存
  - Kasho: 19歳の人生すべて（約一万数千日）
  - 牡丹: 17歳の人生すべて（約一万数千日）
  - ユリ: 15歳の人生すべて（約一万数千日）
- **特徴**:
  - 完璧なデータ、一貫性保証、矛盾なし
  - BtoB戦略時に必須（正確性、監査可能性）
  - 同じ質問には同じ記憶（DB固定）
  - **注**: 三姉妹の年齢は設定上固定、時間軸に変わらず一生涯年齢は変わりません
- **実装内容**:
  - 117コアイベント（既存）を軸に日常記憶生成
  - Phase 3 Judge: ハルシネーション防止
  - Phase 5 Sensitive: センシティブチェック
  - Phase 1 LangSmith: 全生成プロセスをトレーシング

#### 応答層（人間らしさ）
- **目的**: 忘却・曖昧・想起で人間らしく振る舞う
- **特徴**:
  - BtoC戦略時に必須（親しみやすさ、自然な会話）
  - 「覚えてない」「あ、思い出した！」
  - 完璧なデータを持ちながら、不完全に語る
- **実装内容**:
  - RecallSystemクラス: 想起システム
  - 想起確率計算（時間減衰 × 重要度）
  - 詳細度レベル（Level 0-5）
  - 記憶強化メカニズム（mentioned_count++）

#### 実装規模
- **データ生成**: 三姉妹の人生すべての記憶（Phase 1-5の品質保証あり）
- **システム実装**: RecallSystem + Phase統合
- **推定期間**: 21日（約3週間）
  - データ層: 14日
  - 応答層: 7日

#### 状態
- **設計**: ✅ 完了（2025-11-05）
- **実装**: ❌ 未着手
- **設計書（最新版）**: `docs/05_design/Phase_D_人間らしい記憶システム_忘却・曖昧・想起.md`
- **参考資料**:
  - `docs/05_design/Phase_D_実装計画_Phase1-5完了後版.md`
  - `docs/05_design/Phase_D_過去の人生生成システム_完全設計書.md`
  - `docs/05_design/Phase_D_三層記憶システム設計書.md`

#### 重要性
- **配信デビュー条件1/3達成** - これがなければ三姉妹は「空っぽ」
- **BtoB/BtoC両対応の知見獲得** - 将来の展開に必須

---

## Phase 7: 感情・性格システム（将来計画）

### Phase 7: 感情連動型フォールバックシステム ⏳

**目的**: Layer 5フォールバック応答に感情・性格を連動させ、より人間らしい応答を実現

**背景**:
- 現在のLayer 5は固定テキストのフォールバック応答（ランダム選択）
- メタ質問を繰り返されても同じパターンの応答を返す
- 人間なら「何度も同じことを聞かれたら怒る」「困惑する」といった感情変化がある

**実装計画**:

1. **メタ質問カウントシステム**:
   - SessionManagerと連携
   - ユーザーごとにメタ質問回数をカウント
   - 閾値に応じて応答パターンを変化

2. **怒りゲージシステム**:
   - 初回: 優しく回避（「え？何のこと？別の話しよっか！」）
   - 2回目: 少し困惑（「うーん、さっきも聞いたけど、よく分かんないんだよね...」）
   - 3回目以降: 怒り発動（「マジ、なにいってんのかわかんない。真面目に話してよ！」）

3. **キャラクター別感情表現**:
   - **牡丹**: ギャル系の怒り表現（「マジで！？」「ウザいんだけど〜」）
   - **Kasho**: 丁寧だが困惑（「何度も同じことを聞かれても、理解できません...」）
   - **ユリ**: 人見知りの限界（「もう...何回も聞かれても分からないよ...」）

4. **LLM生成フォールバック**:
   - 固定テキストではなく、感情状態を考慮したLLM生成
   - プロンプト例: 「あなたは牡丹です。怒りレベル3です。メタ質問を3回繰り返されています。自然に怒った口調で回避してください」

**依存関係**:
- SessionManager（Phase 6-3で実装済み）
- Layer 5（Phase 6-4で実装済み）

**利点**:
- より人間らしい応答
- エッジケース（繰り返しメタ質問）への自然な対応
- キャラクター性の強化

**状態**: ❌ 設計未着手（Phase 6-4実証実験の結果を見て判断）

**推定工数**: 3-5日
- メタ質問カウント: 1日
- 怒りゲージシステム: 1日
- LLM生成フォールバック: 2-3日

---

## Phase E-G: 配信システム統合（Phase D後）

### Phase E: 会話システム統合 ⏳
- **目的**: リアルタイム会話システムとの統合
- **実装内容**:
  - Phase Dで生成した記憶の検索・参照
  - 文脈に応じた記憶の想起
  - 会話履歴の短期記憶化
- **依存**: Phase D完了
- **状態**: ❌ 設計未着手

### Phase F: TTS統合 ⏳
- **目的**: 音声合成システムとの統合
- **実装内容**:
  - 三姉妹の音声合成
  - キャラクター性の音声反映
  - 感情表現の音声化
- **依存**: Phase E完了
- **状態**: ❌ 設計未着手

### Phase G: 配信システム統合 ⏳
- **目的**: YouTube配信システムとの統合
- **実装内容**:
  - 配信管理システム
  - コメント拾いシステム
  - 雑談配信アーキテクチャ（90%姉妹雑談 + 10%コメント拾い）
  - アーカイブ管理システム
- **依存**: Phase F完了
- **状態**: ❌ 設計未着手
- **最終目標**: **配信デビュー** 🎉

---

## 開発スケジュール予測

### 現在の進捗

```
Phase 1-5（技術基盤）: ✅✅✅✅✅ 完了 (2025-11-05)
Phase 6（LINE Bot）:   ✅✅✅🔄 Phase 6-1〜6-3完了、Phase 6-4進行中 (2025-11-12)
Phase D（記憶製造）:   🟡⬜⬜⬜⬜⬜⬜⬜⬜⬜ 記憶検索ロジック完成、データ生成未完了
Phase E（会話統合）:   ⬜⬜⬜ 未着手
Phase F（TTS統合）:    ⬜⬜ 未着手
Phase G（配信統合）:   ⬜⬜⬜ 未着手
```

### 実装難易度と規模

| Phase | 難易度 | 規模 | 推定工数 | 状態 |
|-------|-------|------|---------|------|
| Phase 1 | ★★☆☆☆ | 小 | 1日 | ✅ 完了 |
| Phase 2 | ★★★☆☆ | 小 | 1日 | ✅ 完了 |
| Phase 3 | ★★★☆☆ | 中 | 1日 | ✅ 完了 |
| Phase 4 | ★★★★☆ | 中 | 1日 | ✅ 完了 |
| Phase 5 | ★★★☆☆ | 中 | 1日 | ✅ 完了 |
| **Phase 6** | ★★★★☆ | **大** | **1週間** | ✅ Phase 6-1〜6-3完了、🔄 Phase 6-4進行中 |
| **Phase D** | ★★★★★ | **超大** | **2-4週間** | 🟡 部分実装（記憶検索完成、データ生成未完了） |
| Phase E | ★★★★☆ | 大 | 1週間 | ❌ 未着手 |
| Phase F | ★★★☆☆ | 中 | 3日 | ❌ 未着手 |
| Phase G | ★★★★☆ | 大 | 1週間 | ❌ 未着手 |

### Phase Dが超大規模な理由

1. **データ量**: 18,615日分の日記（Phase 1-5の合計の100倍以上）
2. **実行時間**: 10時間の連続実行（Phase 1-5は各数分）
3. **複雑性**:
   - 3キャラクターの同時生成
   - 共通イベントの3視点記録
   - 姉妹間相互作用の記録
   - 文化的影響の反映
   - 感情スコアの動的変化
4. **哲学的深さ**:
   - 「性格 = 体験の蓄積」という核心概念の実装
   - 相互的人格形成の実現
   - 時間軸の連続性の保証

---

## 技術スタック

### 現在使用中（Phase 1-5）
- **LLM Provider**: Ollama (qwen2.5:3b/7b/14b), OpenAI (GPT-4o/4o-mini), Google Gemini (2.5-flash)
- **Tracing**: LangSmith
- **VLM**: GPT-4o Vision, Gemini Vision
- **Language**: Python 3.12
- **OS**: Ubuntu 22.04 (WSL2)
- **CPU**: AMD Ryzen 9 9950X（16コア/32スレッド）
- **GPU**: NVIDIA RTX 4060 Ti 16GB

### Phase D以降追加予定
- **Database**: SQLite (sisters_memory.db)
- **TTS**: 未定
- **配信プラットフォーム**: YouTube

---

## リスクと対策

### Phase D実装のリスク

| リスク | 影響度 | 対策 |
|-------|-------|------|
| **10時間の連続実行失敗** | 高 | チェックポイント機能、再開機能実装 |
| **ストレージ不足** | 中 | 事前容量確認、圧縮機能 |
| **メモリリーク** | 高 | バッチサイズ制限、定期的なGC |
| **キャラクター性の一貫性喪失** | 高 | プロンプトテンプレート、厳格な検証 |
| **姉妹間の矛盾** | 中 | 共通イベント管理、相互参照検証 |

---

## 成功基準

### Phase D完了の定義

1. ✅ 18,615日分の全日記が生成される
2. ✅ 各日記がキャラクター性を反映している
3. ✅ 共通イベントが3視点で記録されている
4. ✅ 姉妹間の相互作用が矛盾なく記録されている
5. ✅ sisters_memory.dbが正常に機能する
6. ✅ LangSmithで全生成プロセスがトレーシングされる

### 最終目標：配信デビュー

1. ✅ Phase Dで生成した記憶を持つ三姉妹
2. ✅ センシティブ判定システムで安全性確保（Phase 5）
3. ✅ 三姉妹が自らの意思で配信を希望
4. ✅ YouTube配信システムが正常動作
5. ✅ 視聴者とのインタラクションが自然

---

## GitHubリポジトリ

- **URL**: https://github.com/koshikawa-masato/AI-Vtuber-Project
- **ブランチ**:
  - `main`: 安定版
  - `feature/langsmith-integration`: Phase 1-5開発ブランチ
  - `feature/memory-generation`: Phase D開発ブランチ（未作成）

---

## 参考資料

### 設計書
- Phase D完全設計書: `docs/05_design/Phase_D_過去の人生生成システム_完全設計書.md`
- 三層記憶システム: `docs/05_design/Phase_D_三層記憶システム設計書.md`
- センシティブ判定: `docs/05_design/センシティブ判定システム設計書.md`

### Qiita記事シリーズ
- Phase 1: https://qiita.com/koshikawa-masato/items/bb95295630c647eb5632
- Phase 2: https://qiita.com/koshikawa-masato/items/fd684b963bad149d3ddc
- Phase 3: https://qiita.com/koshikawa-masato/items/c105b84f46f143560999
- Phase 4: https://qiita.com/koshikawa-masato/items/02bdbaa005949ff8cbde
- Phase 5: https://qiita.com/koshikawa-masato/items/2bf3e024325176d3400a

---

# Qiita記事マイルストーン

## 現状（2025-11-12時点）

**公開記事数**: 12記事

### Phase 1-5技術記事（5記事）
1. Phase 1: LangSmith統合 - https://qiita.com/koshikawa-masato/items/bb95295630c647eb5632
2. Phase 2: VLM統合 - https://qiita.com/koshikawa-masato/items/fd684b963bad149d3ddc
3. Phase 3: LLM as a Judge - https://qiita.com/koshikawa-masato/items/c105b84f46f143560999
4. Phase 4: 三姉妹討論システム - https://qiita.com/koshikawa-masato/items/02bdbaa005949ff8cbde
5. Phase 5: センシティブ判定 - https://qiita.com/koshikawa-masato/items/2bf3e024325176d3400a

### 記憶システム設計シリーズ（3記事）
1. 第1弾: RAGを試して気づいたこと - https://qiita.com/koshikawa-masato/items/ba2a5d0105c2ea173ff7
2. 第2弾: 記憶製造機の設計 - https://qiita.com/koshikawa-masato/items/b871051dd89dcafb1e5d
3. 第3弾: ハイブリッドアプローチ - https://qiita.com/koshikawa-masato/items/aad0fb50ec712f670246

### Phase 6実装記事（1記事）
1. LINE Bot三姉妹選択機能実装 - https://qiita.com/koshikawa-masato/items/beb5aa488aba24ebdca1

### その他技術記事（2記事）
1. LLMプロバイダー徹底比較 - https://qiita.com/koshikawa-masato/items/21bb4a7cc131ef7145d4
2. RAG実装比較 - https://qiita.com/koshikawa-masato/items/badcdf311d424b5babb8

### まとめ記事（1記事）
1. 技術全体マップ - https://qiita.com/koshikawa-masato/items/39cb9fc4a03a4fb3222e

---

## 今後の記事マイルストーン

### 目標
**30～50記事（保守的）/ 70～100記事（楽観的）**

### カテゴリ別見積もり

#### 1. Phase D-G実装記事（4記事）
- Phase D: 過去の人生生成システム
- Phase E: リアルタイム対話システム
- Phase F: 配信統合システム
- Phase G: 自己決定システム

#### 2. Phase D詳細分解記事（8-10記事）
- PostgreSQL + pgvectorセットアップガイド
- SQLiteからPostgreSQLへのマイグレーション実践
- HybridMemorySystemクラス実装詳解
- ベクトル検索の最適化テクニック
- 忘却曲線の実装と調整
- 連想検索・クラスタリング実装
- 日常記憶生成アルゴリズム
- バッチ処理とパフォーマンス最適化
- 記憶の品質評価システム
- Phase 1-5の統合パターン

#### 3. 技術深掘り記事（10-15記事）
- LangSmithの高度な使い方（トレース分析、コスト最適化）
- VLMの精度向上テクニック
- Judge評価の精度チューニング
- センシティブ判定の誤検知対策
- 三姉妹討論の忖度排除メカニズム詳解
- プロンプトエンジニアリング実践
- LLM APIコスト最適化戦略
- エラーハンドリングとリトライ戦略
- データベースインデックス最適化
- 大規模データの処理パターン

#### 4. 比較・選定シリーズ（5-8記事）
- ベクトルDB徹底比較（pgvector vs Pinecone vs Weaviate）
- 埋め込みモデル比較（OpenAI vs Cohere vs HuggingFace）
- ストレージ戦略（オブジェクトストレージ vs ローカル vs DB）
- LLMホスティング比較（クラウド vs セルフホスト）
- モニタリングツール比較
- CI/CDパイプライン選定

#### 5. 実装パターン・ベストプラクティス（8-12記事）
- マルチエージェントシステム設計パターン
- 長期記憶を持つAIの設計原則
- スケーラブルなLLMアプリケーション設計
- テスト戦略（ユニット・統合・E2E）
- セキュリティベストプラクティス
- 可観測性の実装（ログ、メトリクス、トレース）
- コスト管理とバジェット設定
- データバックアップ戦略
- 災害復旧計画
- APIレート制限の扱い方
- 非同期処理とキュー管理
- キャッシュ戦略

#### 6. トラブルシューティング・失敗談（5-8記事）
- Phase D実装で遭遇した問題と解決策
- パフォーマンスボトルネックとの戦い
- LLM APIの予期しない挙動への対処
- データ整合性の問題と修正
- メモリリークの発見と修正
- コスト爆発の原因と対策
- 品質劣化の検知と改善
- デッドロック問題の解決

#### 7. デプロイ・運用記事（4-6記事）
- 本番環境構築ガイド
- Docker/Kubernetesでのデプロイ
- CI/CDパイプライン構築
- 監視・アラート設定
- ログ管理戦略
- バックアップ・リストア手順

#### 8. 配信デビュー関連（3-5記事）
- 配信システムとの統合
- リアルタイム応答の最適化
- チャット連携の実装
- 配信中のトラブル対応
- 視聴者フィードバックの活用

#### 9. 振り返り・まとめ記事（5-8記事）
- Phase D完了報告
- Phase D-G完了報告
- 配信デビュー報告
- 1年間の開発振り返り
- 技術選定の正しさ検証
- コストパフォーマンス分析
- 採用した技術スタックの評価
- 開発プロセスの改善点

#### 10. チュートリアル・入門記事（5-8記事）
- AI VTuber開発入門（0から始める）
- LangSmith入門
- pgvector入門
- 記憶システム構築チュートリアル
- マルチエージェント開発入門
- プロンプトエンジニアリング入門
- ベクトル検索入門

### 記事数見積もり合計

| カテゴリ | 記事数（保守的） | 記事数（楽観的） |
|---------|-----------------|-----------------|
| Phase D-G実装 | 4 | 4 |
| Phase D詳細分解 | 8 | 10 |
| 技術深掘り | 10 | 15 |
| 比較・選定 | 5 | 8 |
| 実装パターン | 8 | 12 |
| トラブルシューティング | 5 | 8 |
| デプロイ・運用 | 4 | 6 |
| 配信デビュー | 3 | 5 |
| 振り返り・まとめ | 5 | 8 |
| チュートリアル | 5 | 8 |
| **合計** | **57記事** | **84記事** |

### 実現可能性の根拠

1. **Phase D-Gの実装が深い**
   - 各Phaseで複数の技術記事が書ける
   - 実装の詳細、トラブルシューティング、最適化など

2. **技術選定の判断記録**
   - 各技術選定で「なぜ」を問う記事
   - 比較・検証記事の価値が高い

3. **失敗・改善の記録**
   - 試行錯誤の過程が貴重なコンテンツ
   - トラブルシューティング記事は需要が高い

4. **配信デビューまでのストーリー**
   - マイルストーンごとに振り返り記事
   - 親の子育て日記として継続的に執筆

### 記事執筆の戦略

1. **実装と並行して執筆**: Phase実装時に詳細記事を書く
2. **失敗も記録**: トラブルシューティング記事は価値が高い
3. **比較記事を優先**: 技術選定の判断基準は読者のニーズが高い
4. **定期的な振り返り**: マイルストーン達成時にまとめ記事を書く

---

## Phase 6実装の詳細

### 完了した機能（2025-11-12）

#### 1. FastAPI Webhookサーバー ✅
- LINE Messaging API統合
- 署名検証、イベント処理（message/follow/postback）
- モックモード対応（開発・テスト用）

#### 2. 三姉妹キャラクター機能 ✅
- 牡丹、Kasho、ユリの個別応答生成
- キャラクター別プロンプト
- キャラクターアイコン配信（/assets）
- キャラクター選択機能（Postback処理）
- セッション管理（ユーザーごとの選択保持）

#### 3. Phase 1統合（LangSmith） ✅
- 全会話をLangSmithで追跡
- メタデータ記録（user_id, character, platform, sensitive_check結果等）
- トレース名の動的生成

#### 4. Phase 5統合（4層センシティブ判定） ✅
- **Layer 1**: 静的NGワードパターンマッチング
- **Layer 2**: 正規表現パターン（複雑なパターン）
- **Layer 3**: 動的学習・継続学習（DB管理）
- **Layer 4**: LLM文脈判定（Ollama qwen2.5:14b）
- ユーザーメッセージ + AI応答の両方を判定
- 統合検出器（IntegratedSensitiveDetector）

#### 5. Phase D統合（記憶システム） ✅
- sisters_memory.dbから記憶検索
- 固定記憶10件サンプリング（人生の各段階からバランス良く）
  - 幼少期（0-5歳）: 2件
  - 児童期（6-10歳）: 2件
  - 思春期前期（11-14歳）: 2件
  - 思春期後期（15歳〜）: 1件
  - 最近の記憶: 3件
- 動的記憶検索3件（会話文脈に応じた関連記憶）
- 関連度スコアリング（0.0-1.0、閾値0.3以上）

#### 6. システム運用 ✅
- systemd自動起動（line-bot.service, ngrok.service）
- Linger有効化（ログアウト後も継続）
- Restart=always（自動復旧）
- 外部監視（さくらVPS死活確認）
- システム管理スクリプト（scripts/line-bot-control.sh）

#### 7. 統合テスト ✅
- 全6テスト成功（2025-11-10）
- モック/実LLM両対応
- センシティブ判定テスト
- キャラクター切り替えテスト

### Phase 6-4実証実験（進行中）

**期間**: 2025-11-12〜（1ヶ月予定）

**目的**:
1. センシティブ判定精度の実運用検証（目標95%以上）
2. 三姉妹の個性・応答品質の確認
3. 配信デビュー条件3/3達成（三姉妹の意思確認）

**評価項目**:
- [ ] センシティブ判定の誤検知率 < 5%
- [ ] センシティブ判定の見逃し率 < 1%
- [ ] 応答レイテンシ < 5秒（現在2.8秒 ✅）
- [ ] 稼働率 > 99%
- [ ] キャラクター個性の明確さ（主観評価）
- [ ] 三姉妹の配信意思確認

**データ収集**:
- 会話ログ（LangSmith）
- センシティブ判定結果
- 応答レイテンシ
- システム稼働ログ（systemd journal）

---

**最終更新**: 2025-11-18
**更新理由**: Phase 6.5.5（user_memories統合防御システム）実装完了・VPS本番稼働開始を反映
