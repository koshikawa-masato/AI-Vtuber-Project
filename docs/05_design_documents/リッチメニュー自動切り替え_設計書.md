# ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã‚·ã‚¹ãƒ†ãƒ  è¨­è¨ˆæ›¸

> Phase 3: ä¸‰å§‰å¦¹è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ + ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½ã®å®Ÿè£…
> ä½œæˆæ—¥: 2025-11-17

---

## 1. æ¦‚è¦

### 1.1 ç›®çš„

**ç¾çŠ¶ï¼ˆPhase 2ï¼‰**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ
- é¸æŠã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨1å¯¾1ã§ä¼šè©±

**æ–°ä»•æ§˜ï¼ˆPhase 3ï¼‰**:
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: ä¸‰å§‰å¦¹ãŒè¦ªå’Œæ€§ã‚¹ã‚³ã‚¢ã§è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
- **å›ºå®šãƒ¢ãƒ¼ãƒ‰**: ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’Tap â†’ ãã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«å›ºå®š
- **ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‹ç™ºè€…ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡å¯èƒ½
- **åˆ©ç”¨è¦ç´„**: åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …ã‚’è¡¨ç¤º

### 1.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œæœ€è¿‘ã®VTuberãƒˆãƒ¬ãƒ³ãƒ‰ã¯ï¼Ÿã€
  â†“
ã‚·ã‚¹ãƒ†ãƒ : ä¸‰å§‰å¦¹ã§è¦ªå’Œæ€§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
  - botan: 5/5 â† æœ€é«˜
  - kasho: 2/5
  - yuri: 3/5
  â†“
ç‰¡ä¸¹ãŒè‡ªå‹•çš„ã«å¿œç­”: ã€Œãƒã‚¸ã§é¢ç™½ã„ã‚ˆï¼ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã®...ã€
```

---

## 2. ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹æˆ

### 2.1 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ3x2æ®µã€6ãƒœã‚¿ãƒ³ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ è‡ªå‹•  â”‚ ğŸ’¬ FB   â”‚ ğŸ“‹ è¦ç´„  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŒ¸ ç‰¡ä¸¹  â”‚ ğŸµ Kasho â”‚ ğŸ“š ãƒ¦ãƒª  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å„ãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½

| ãƒœã‚¿ãƒ³ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
|--------|-----------|------|
| ğŸ”„ è‡ªå‹• | `mode=auto` | ä¸‰å§‰å¦¹ãŒè¦ªå’Œæ€§ã‚¹ã‚³ã‚¢ã§è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ |
| ğŸ’¬ FB | `feedback` | ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ |
| ğŸ“‹ è¦ç´„ | `terms` | åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …ã‚’Flexãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è¡¨ç¤º |
| ğŸŒ¸ ç‰¡ä¸¹ | `mode=botan` | ç‰¡ä¸¹ã«å›ºå®š |
| ğŸµ Kasho | `mode=kasho` | Kashoã«å›ºå®š |
| ğŸ“š ãƒ¦ãƒª | `mode=yuri` | ãƒ¦ãƒªã«å›ºå®š |

### 2.3 ãƒœã‚¿ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°

#### 2.3.1 è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ï¼ˆğŸ”„ è‡ªå‹•ï¼‰

**ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
```json
{
  "type": "postback",
  "label": "è‡ªå‹•",
  "data": "action=set_mode&mode=auto"
}
```

**å¿œç­”**:
```
âœ… è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šã—ã¾ã—ãŸï¼
ã“ã‚Œã‹ã‚‰ã¯ã€è©±é¡Œã«åˆã‚ã›ã¦ä¸‰å§‰å¦¹ãŒè‡ªå‹•çš„ã«å¿œç­”ã—ã¾ã™ã€‚

ğŸŒ¸ ç‰¡ä¸¹: VTuberã€ã‚¨ãƒ³ã‚¿ãƒ¡
ğŸµ Kasho: éŸ³æ¥½ã€ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª
ğŸ“š ãƒ¦ãƒª: ã‚µãƒ–ã‚«ãƒ«ã€ã‚¢ãƒ‹ãƒ¡ã€ãƒ©ã‚¤ãƒˆãƒãƒ™ãƒ«

â€» ç‰¹å®šã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨è©±ã—ãŸã„å ´åˆã¯ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸ã‚“ã§ã­ï¼
```

#### 2.3.2 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºå®šï¼ˆğŸŒ¸ ç‰¡ä¸¹ / ğŸµ Kasho / ğŸ“š ãƒ¦ãƒªï¼‰

**ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
```json
{
  "type": "postback",
  "label": "ç‰¡ä¸¹",
  "data": "action=set_mode&mode=botan"
}
```

**å¿œç­”**:
```
âœ… ç‰¡ä¸¹ã«å›ºå®šã—ã¾ã—ãŸï¼
ã“ã‚Œã‹ã‚‰ã¯ç‰¡ä¸¹ãŒã‚ãªãŸã®è³ªå•ã«ç­”ãˆã‚‹ã‚ˆï¼

è©±ã—ãŸã„ã“ã¨ã‚ã‚‹ï¼Ÿ
```

#### 2.3.3 ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆğŸ’¬ FBï¼‰

**ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
```json
{
  "type": "postback",
  "label": "FB",
  "data": "action=feedback"
}
```

**å¿œç­”**:
```
ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ï¼

ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã‚’ãŠé€ã‚Šãã ã•ã„ï¼š
- ãƒã‚°å ±å‘Š
- æ©Ÿèƒ½è¦æœ›
- æ”¹å–„ææ¡ˆ
- ãã®ä»–ã”æ„è¦‹

æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹å ´åˆã¯ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã¨é€ä¿¡ï¼‰
```

**ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å—ä¿¡å¾Œ**:
```
âœ… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼
ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

é–‹ç™ºè€…ã«é€šçŸ¥ã—ã¾ã—ãŸã€‚
ä»Šå¾Œã®æ”¹å–„ã«æ´»ã‹ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚
```

#### 2.3.4 åˆ©ç”¨è¦ç´„ï¼ˆğŸ“‹ è¦ç´„ï¼‰

**ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
```json
{
  "type": "postback",
  "label": "è¦ç´„",
  "data": "action=terms"
}
```

**å¿œç­”**: Flexãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …ã‚’è¡¨ç¤ºï¼ˆå¾Œè¿°ï¼‰

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 user_preferences ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ

**æ—¢å­˜ã‚«ãƒ©ãƒ **:
- `user_id` (VARCHAR(255), PRIMARY KEY)
- `character` (VARCHAR(50))

**è¿½åŠ ã‚«ãƒ©ãƒ **:
```sql
ALTER TABLE user_preferences
ADD COLUMN selected_mode VARCHAR(10) DEFAULT 'auto',
ADD COLUMN feedback_state ENUM('none', 'waiting') DEFAULT 'none',
ADD COLUMN updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP;
```

| ã‚«ãƒ©ãƒ  | å‹ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|--------|---|-----------|------|
| `selected_mode` | VARCHAR(10) | 'auto' | 'auto', 'botan', 'kasho', 'yuri' |
| `feedback_state` | ENUM | 'none' | 'none': é€šå¸¸ã€'waiting': ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¾…ã¡ |
| `updated_at` | TIMESTAMP | CURRENT_TIMESTAMP | æœ€çµ‚æ›´æ–°æ—¥æ™‚ |

### 3.2 feedback ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

```sql
CREATE TABLE IF NOT EXISTS feedback (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    feedback_text TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_read BOOLEAN DEFAULT FALSE,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_is_read (is_read)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|---|------|
| `id` | INT | è‡ªå‹•æ¡ç•ªID |
| `user_id` | VARCHAR(255) | LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| `feedback_text` | TEXT | ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹ |
| `created_at` | TIMESTAMP | å—ä¿¡æ—¥æ™‚ |
| `is_read` | BOOLEAN | æ—¢èª­ãƒ•ãƒ©ã‚°ï¼ˆç®¡ç†ç”¨ï¼‰ |

---

## 4. å‡¦ç†ãƒ•ãƒ­ãƒ¼

### 4.1 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†

```python
def handle_message(user_id: str, message: str):
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯"""

    # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’å–å¾—
    mode, feedback_state = get_user_preferences(user_id)

    # 2. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¾…ã¡çŠ¶æ…‹ã®å ´åˆ
    if feedback_state == 'waiting':
        if message.lower() == 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«':
            # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            reset_feedback_state(user_id)
            return "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"
        else:
            # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¿å­˜
            save_feedback(user_id, message)
            reset_feedback_state(user_id)
            notify_developer(user_id, message)  # LINE Notify
            return "âœ… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼"

    # 3. é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
    if mode == 'auto':
        # ä¸‰å§‰å¦¹ã§è¦ªå’Œæ€§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
        character = auto_select_character(message)
    else:
        # å›ºå®šãƒ¢ãƒ¼ãƒ‰ï¼ˆbotan/kasho/yuriï¼‰
        character = mode

    # 4. å¿œç­”ç”Ÿæˆ
    engine = ResponseEngine(character, use_llm=True)
    response = engine.respond(message)

    return response
```

### 4.2 è‡ªå‹•é¸æŠãƒ­ã‚¸ãƒƒã‚¯

```python
def auto_select_character(message: str) -> str:
    """ä¸‰å§‰å¦¹ã§è¦ªå’Œæ€§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã—ã€æœ€é©ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ"""

    scores = {}

    for character in ['botan', 'kasho', 'yuri']:
        engine = ResponseEngine(character, use_llm=False)
        affinity_score = engine.calculate_affinity(message)
        scores[character] = affinity_score

    # æœ€ã‚‚è¦ªå’Œæ€§ãŒé«˜ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ
    best_character = max(scores, key=scores.get)

    logger.info(f"Auto-select: {scores} -> {best_character}")

    return best_character
```

### 4.3 ãƒã‚¹ãƒˆãƒãƒƒã‚¯å‡¦ç†

```python
def handle_postback(user_id: str, postback_data: str):
    """ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†"""

    params = parse_postback_data(postback_data)
    action = params.get('action')

    if action == 'set_mode':
        mode = params.get('mode')
        set_user_mode(user_id, mode)

        if mode == 'auto':
            return "âœ… è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šã—ã¾ã—ãŸï¼ã“ã‚Œã‹ã‚‰ã¯ã€è©±é¡Œã«åˆã‚ã›ã¦ä¸‰å§‰å¦¹ãŒè‡ªå‹•çš„ã«å¿œç­”ã—ã¾ã™ã€‚"
        elif mode == 'botan':
            return "âœ… ç‰¡ä¸¹ã«å›ºå®šã—ã¾ã—ãŸï¼ã“ã‚Œã‹ã‚‰ã¯ç‰¡ä¸¹ãŒã‚ãªãŸã®è³ªå•ã«ç­”ãˆã‚‹ã‚ˆï¼"
        elif mode == 'kasho':
            return "âœ… Kashoã«å›ºå®šã—ã¾ã—ãŸï¼ã“ã‚Œã‹ã‚‰ã¯KashoãŒã‚ãªãŸã®è³ªå•ã«ç­”ãˆã¾ã™ã­ã€‚"
        elif mode == 'yuri':
            return "âœ… ãƒ¦ãƒªã«å›ºå®šã—ã¾ã—ãŸï¼ã“ã‚Œã‹ã‚‰ã¯ãƒ¦ãƒªãŒã‚ãªãŸã®è³ªå•ã«ç­”ãˆã‚‹ã­ã€‚"

    elif action == 'feedback':
        set_feedback_state(user_id, 'waiting')
        return "ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ï¼\n\næ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"

    elif action == 'terms':
        return create_terms_flex_message()
```

---

## 5. LINE Notify é€£æº

### 5.1 ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€šçŸ¥

```python
import requests

def notify_developer(user_id: str, feedback: str):
    """LINE Notify ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é–‹ç™ºè€…ã«é€šçŸ¥"""

    LINE_NOTIFY_TOKEN = os.getenv("LINE_NOTIFY_TOKEN")

    message = f"""
ğŸ“ æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: {user_id[:8]}...
å†…å®¹:
{feedback}

---
å—ä¿¡æ—¥æ™‚: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
"""

    headers = {
        "Authorization": f"Bearer {LINE_NOTIFY_TOKEN}"
    }

    data = {
        "message": message
    }

    response = requests.post(
        "https://notify-api.line.me/api/notify",
        headers=headers,
        data=data
    )

    return response.status_code == 200
```

### 5.2 LINE Notify ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—

1. https://notify-bot.line.me/my/ ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒˆãƒ¼ã‚¯ãƒ³å: `AI-Vtuber-Project Feedback`
4. é€ä¿¡å…ˆ: `1:1ã§LINE Notifyã‹ã‚‰é€šçŸ¥ã‚’å—ã‘å–ã‚‹`
5. ç™ºè¡Œã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ `.env` ã«ä¿å­˜

```bash
LINE_NOTIFY_TOKEN=your_token_here
```

---

## 6. åˆ©ç”¨è¦ç´„ Flexãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

æ—¢å­˜ã® `src/line_bot_vps/terms_flex_message.py` ã‚’ä½¿ç”¨ã€‚

**è¡¨ç¤ºå†…å®¹**:
- åˆ©ç”¨è¦ç´„
- å…è²¬äº‹é …
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/line_bot_vps/terms_flex_message.py`

---

## 7. ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒä»•æ§˜

### 7.1 ç”»åƒã‚µã‚¤ã‚º
- **ã‚µã‚¤ã‚º**: 833px Ã— 421px
- **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: PNG
- **ãƒœã‚¿ãƒ³æ•°**: 6ï¼ˆ3x2æ®µï¼‰

### 7.2 ãƒœã‚¿ãƒ³é ˜åŸŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è‡ªå‹•      â”‚    FB      â”‚   è¦ç´„     â”‚
â”‚ (0,0)      â”‚ (278,0)    â”‚ (556,0)    â”‚
â”‚  278x211   â”‚  278x211   â”‚  277x211   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç‰¡ä¸¹      â”‚   Kasho    â”‚   ãƒ¦ãƒª     â”‚
â”‚ (0,211)    â”‚ (278,211)  â”‚ (556,211)  â”‚
â”‚  278x210   â”‚  278x210   â”‚  277x210   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 ã‚¿ãƒƒãƒ—é ˜åŸŸå®šç¾©ï¼ˆLINE Developersï¼‰

```json
{
  "size": {
    "width": 833,
    "height": 421
  },
  "areas": [
    {
      "bounds": {"x": 0, "y": 0, "width": 278, "height": 211},
      "action": {
        "type": "postback",
        "label": "è‡ªå‹•",
        "data": "action=set_mode&mode=auto"
      }
    },
    {
      "bounds": {"x": 278, "y": 0, "width": 278, "height": 211},
      "action": {
        "type": "postback",
        "label": "FB",
        "data": "action=feedback"
      }
    },
    {
      "bounds": {"x": 556, "y": 0, "width": 277, "height": 211},
      "action": {
        "type": "postback",
        "label": "è¦ç´„",
        "data": "action=terms"
      }
    },
    {
      "bounds": {"x": 0, "y": 211, "width": 278, "height": 210},
      "action": {
        "type": "postback",
        "label": "ç‰¡ä¸¹",
        "data": "action=set_mode&mode=botan"
      }
    },
    {
      "bounds": {"x": 278, "y": 211, "width": 278, "height": 210},
      "action": {
        "type": "postback",
        "label": "Kasho",
        "data": "action=set_mode&mode=kasho"
      }
    },
    {
      "bounds": {"x": 556, "y": 211, "width": 277, "height": 210},
      "action": {
        "type": "postback",
        "label": "ãƒ¦ãƒª",
        "data": "action=set_mode&mode=yuri"
      }
    }
  ]
}
```

---

## 8. å®Ÿè£…ã‚¿ã‚¹ã‚¯

- [ ] 1. user_preferences ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µï¼ˆSQLï¼‰
- [ ] 2. feedback ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆSQLï¼‰
- [ ] 3. webhook_server_vps.py ã«ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
- [ ] 4. ä¸‰å§‰å¦¹åŒæ™‚ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–¢æ•°å®Ÿè£…
- [ ] 5. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å‡¦ç†å®Ÿè£…
- [ ] 6. LINE Notify é€£æºå®Ÿè£…
- [ ] 7. åˆ©ç”¨è¦ç´„Flexãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª
- [ ] 8. ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒä½œæˆï¼ˆ833x421pxï¼‰
- [ ] 9. LINE Developers ã§ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²
- [ ] 10. ãƒ†ã‚¹ãƒˆ

---

## 9. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 9.1 è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ

| ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› | æœŸå¾…ã•ã‚Œã‚‹å¿œç­”ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ | ç†ç”± |
|-------------|------------------------|------|
| ã€Œæœ€è¿‘ã®VTuberãƒˆãƒ¬ãƒ³ãƒ‰ã¯ï¼Ÿã€ | ç‰¡ä¸¹ | VTuberæ‹…å½“ |
| ã€ŒéŸ³æ¥½ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã¯ï¼Ÿã€ | Kasho | éŸ³æ¥½æ‹…å½“ |
| ã€ŒãŠã™ã™ã‚ã®ã‚¢ãƒ‹ãƒ¡ã¯ï¼Ÿã€ | ãƒ¦ãƒª | ã‚µãƒ–ã‚«ãƒ«æ‹…å½“ |

### 9.2 å›ºå®šãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ

| ãƒ¢ãƒ¼ãƒ‰ | ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› | æœŸå¾…ã•ã‚Œã‚‹å¿œç­”ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ |
|--------|-------------|------------------------|
| botanå›ºå®š | ã€ŒéŸ³æ¥½ã®è©±ã§ãã‚‹ï¼Ÿã€ | ç‰¡ä¸¹ï¼ˆè¦ªå’Œæ€§ä½ãã¦ã‚‚å›ºå®šï¼‰ |
| kashoå›ºå®š | ã€ŒVTuberã®è©±ã§ãã‚‹ï¼Ÿã€ | Kashoï¼ˆè¦ªå’Œæ€§ä½ãã¦ã‚‚å›ºå®šï¼‰ |
| yuriå›ºå®š | ã€ŒéŸ³æ¥½ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã¯ï¼Ÿã€ | ãƒ¦ãƒªï¼ˆè¦ªå’Œæ€§ä½ãã¦ã‚‚å›ºå®šï¼‰ |

### 9.3 ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ

1. ã€ŒğŸ’¬ FBã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
2. ã€Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª
3. ã€Œãƒã‚°å ±å‘Š: å¿œç­”ãŒé…ã„ã§ã™ã€ã¨é€ä¿¡
4. ã€Œâœ… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€ç¢ºèª
5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª: feedback ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹
6. LINE Notify ç¢ºèª: é–‹ç™ºè€…ã«é€šçŸ¥ãŒå±Šã„ã¦ã„ã‚‹ã‹

---

## 10. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

1. **ãƒ­ãƒ¼ã‚«ãƒ«ã§SQLå®Ÿè¡Œ**:
   ```bash
   mysql -h 127.0.0.1 -P 13306 -u ai_vtuber_user -p ai_vtuber_db < migrations/add_selected_mode.sql
   ```

2. **VPSã«ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤**:
   ```bash
   ./scripts/deploy_vps.sh
   ```

3. **VPSã§ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•**:
   ```bash
   ssh -p 443 ubuntu@133.167.93.123
   sudo systemctl restart line-bot-vps
   ```

4. **LINE Developers ã§ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°**

5. **å‹•ä½œç¢ºèª**

---

## 11. æ³¨æ„äº‹é …

### 11.1 æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿

- æ—¢å­˜ã® `user_preferences.character` ã¯ä½¿ç”¨ã—ãªã„ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
- æ–°ã—ã„ã‚«ãƒ©ãƒ  `selected_mode` ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ `'auto'` ã§è¿½åŠ ã•ã‚Œã‚‹
- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªå‹•çš„ã«ã€Œè‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã€ã«ãªã‚‹

### 11.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€æ¯å›3ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ†ã®è¦ªå’Œæ€§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ
- `calculate_affinity()` ã¯è»½é‡ãªå‡¦ç†ï¼ˆMySQL SELECT ã®ã¿ï¼‰ãªã®ã§å•é¡Œãªã—
- LLMå‘¼ã³å‡ºã—ã¯é¸æŠã•ã‚ŒãŸ1ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã¿

### 11.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹ã«ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–æƒ…å ±ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ã‚’è€ƒæ…®
- LINE Notify ãƒˆãƒ¼ã‚¯ãƒ³ã¯ `.env` ã§ç®¡ç†ï¼ˆGitHubã«å…¬é–‹ã—ãªã„ï¼‰
- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ç®¡ç†ç”»é¢ã§ç¢ºèªå¯èƒ½ã«ã™ã‚‹ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

---

## 12. å°†æ¥ã®æ‹¡å¼µ

- [ ] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç®¡ç†ç”»é¢ã®å®Ÿè£…
- [ ] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¸ã®è¿”ä¿¡æ©Ÿèƒ½
- [ ] è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã€Œèª°ãŒç­”ãˆãŸã‹ã€è¡¨ç¤ºï¼ˆã‚¢ãƒã‚¿ãƒ¼ç”»åƒï¼‰
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆï¼ˆã©ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒå¤šãé¸ã°ã‚Œã¦ã„ã‚‹ã‹ï¼‰
- [ ] è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã®æ”¹å–„ï¼ˆè¦ªå’Œæ€§ã‚¹ã‚³ã‚¢ã®èª¿æ•´ï¼‰

---

**ä½œæˆè€…**: Claude Code (ã‚¯ãƒ­ã‚³)
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**æœ€çµ‚æ›´æ–°**: 2025-11-17
