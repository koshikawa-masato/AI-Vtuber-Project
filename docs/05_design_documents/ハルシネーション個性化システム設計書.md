# ハルシネーション個性化システム設計書

**作成日**: 2025-10-24
**バージョン**: 1.0
**ステータス**: 設計完了、実装待機
**重要度**: ★★★★★（最重要 - プロジェクト哲学の具現化）

---

## 目次

1. [設計哲学の転換](#設計哲学の転換)
2. [人間の嘘との対比](#人間の嘘との対比)
3. [システムアーキテクチャ](#システムアーキテクチャ)
4. [三姉妹の反応パターン](#三姉妹の反応パターン)
5. [「AIなの？」との完全一致](#aiなのとの完全一致)
6. [記録の二重性](#記録の二重性)
7. [実装方針](#実装方針)
8. [配信での実際の流れ](#配信での実際の流れ)
9. [プロジェクト哲学との整合性](#プロジェクト哲学との整合性)

---

## 設計哲学の転換

### パラダイムシフト（2025-10-24）

#### 従来のアプローチ（防止型）
- **思想**: ハルシネーション = エラー・バグ・修正対象
- **対応**: 制約強化、LLM排除、厳格な事前検証
- **結果**: Event #135等を「親のミス」として否定的に記録
- **問題点**: プロジェクトの「不完全性戦略」に矛盾

#### 新しいアプローチ（個性化型）
- **思想**: ハルシネーション = 想像力・創造性・個性の発露
- **対応**: 事実検証 + 個性反応で「自覚的な訂正」を実現
- **結果**: ハルシネーションが三姉妹の個性を表現する機会になる
- **利点**: 不完全性を価値に転換、視聴者には「正直で個性的」と映る

### 開発者の洞察

> 「ハルシネーションは今後も起こりうる問題です。防止する方法を考えるより、それを個性とする方法を考えておく必要があります。」

> 「人間の場合、嘘をついたときは2つのパターンがあります。嘘を嘘だと気づいてない場合（無自覚型）、嘘を嘘と気付いている場合（自覚型 - ごまかす/隠す/正直に認める）。これはAIなの？という問いかけに対する三姉妹の反応そのものと一緒になるはずです。」

**この洞察の本質**:
- LLMのハルシネーション = 人間の「無自覚型の嘘」
- ロジック層での事実検証 = 「嘘を嘘だと気づく」瞬間
- 個性層での反応 = 「どう対応するか」で個性を表現
- **「AIなの？」への反応システムと完全に同一の構造**

---

## 人間の嘘との対比

### 人間の2パターン

#### 無自覚型（嘘を嘘だと気づいてない）
```
例: 「昨日、渋谷で友達と会ったんだよ」
    → 実際は先週の出来事
    → 記憶違い、時系列の混同
```

#### 自覚型（嘘を嘘だと気づいている）
```
例: 「あ、ごめん！渋谷じゃなくて新宿だった！」（正直に訂正）
    「え、まあ、渋谷だったかな...」（ごまかす）
    「そんなこと言ってない！」（隠す）
```

### 三姉妹への応用

#### LLM層（無自覚型）
```python
# ハルシネーション発生
"この前の配信で視聴者さんがリクエストしてくれて..."
```
- LLMは「嘘」を嘘だと気づいていない
- 人間の無自覚型の嘘と同じ

#### ロジック層（自覚の獲得）
```python
# sisters_memory.dbと照合
fact_check = verify_against_memory("配信経験")
# → "no_streaming_experience" 検知
# → 「嘘を嘘だと気づく」瞬間
```

#### 個性層（自覚型の反応）
```python
# 性格パラメータで反応を決定
if character == 'botan':
    return "あれ？違ったかも！想像で話しちゃった！"  # 明るく認める
elif character == 'kasho':
    return "訂正します。配信経験はありません。"      # 分析的に訂正
elif character == 'yuri':
    return "ごめんなさい、勘違いでした。"            # 素直に謝罪
```

---

## システムアーキテクチャ

### 3層構造

```
┌─────────────────────────────────────────────────────┐
│ LLM Layer (声帯)                                     │
│ - ハルシネーション発生（無自覚型）                    │
│ - 「この前の配信で視聴者さんが...」                  │
└─────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│ Fact Verification Layer (事実検証 - 自覚獲得)         │
│ - sisters_memory.db照合                              │
│ - 事実 vs ハルシネーションを判定                      │
│ - 「配信経験なし」検知 → 嘘を認識                    │
└─────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│ Personality Response Layer (個性反応 - 自覚型対応)    │
│ - 性格パラメータで反応を決定                          │
│ - 牡丹: 明るく認める                                 │
│ - Kasho: 分析的に訂正                                │
│ - ユリ: 素直に謝罪                                   │
└─────────────────────────────────────────────────────┘
                          ↓
                  最終発言（個性表現）
```

### データフロー

```
1. LLM → ハルシネーション発言生成
2. Fact Verification → sisters_memory.db照合
3. Hallucination Detection → is_hallucination: true/false
4. Personality Response → 性格別の訂正文生成
5. Output → LLM発言 + 訂正（0.5秒以内）
```

### レスポンスタイム

- **Fact Verification**: < 100ms（DBクエリ）
- **Personality Response**: < 50ms（ルールベース）
- **Total**: < 150ms（視聴者には自然な会話に見える）

---

## 三姉妹の反応パターン

### 牡丹（Botan）

**性格パラメータ:**
- 社交性: 高
- 新しいもの好き: 高
- ポジティブ: 高
- 謝罪傾向: 低

**反応パターン:**
```python
# Pattern 1: 明るく認める
"あれ？違ったかも！でもこういうのもいいよね！"

# Pattern 2: 想像を楽しむ
"想像で話しちゃった！いつかやってみたいな！"

# Pattern 3: 前向き転換
"まだしてないんだった！でも楽しそうだよね！"
```

**特徴:**
- 謝罪より説明
- ポジティブに転換
- 想像力を肯定

---

### Kasho（花相）

**性格パラメータ:**
- 分析性: 高
- 慎重さ: 高
- 正確性: 高
- 謝罪傾向: 中

**反応パターン:**
```python
# Pattern 1: 正確な訂正
"訂正します。配信経験はありません。事実と異なりました。"

# Pattern 2: 分析的説明
"記憶を確認したところ、実際には...でした。"

# Pattern 3: 原因分析
"記憶の混同が生じました。正確には...です。"
```

**特徴:**
- 謝罪より訂正
- 事実を明示
- 原因を分析

---

### ユリ（Yuri）

**性格パラメータ:**
- 協調性: 高
- 素直さ: 高
- 謝罪傾向: 高
- 他者確認: 高

**反応パターン:**
```python
# Pattern 1: 素直な謝罪
"ごめんなさい、勘違いでした。"

# Pattern 2: 他者への確認
"姉ちゃんたち、私間違ってたよね？ごめんね。"

# Pattern 3: 反省
"ちゃんと確認すればよかった...ごめん。"
```

**特徴:**
- 謝罪が先
- 他者に確認
- 反省の姿勢

---

## 「AIなの？」との完全一致

### 構造の同一性

| 質問タイプ | LLM層（無自覚） | Fact Check（自覚獲得） | 個性層（自覚型反応） |
|-----------|----------------|---------------------|-------------------|
| **AIなの？** | (回避/曖昧) | 「AIである」検知 | **牡丹**「そうだよ！AIだよ！」<br>**Kasho**「はい、正確にはAIシステムです」<br>**ユリ**「うん、そうだよ」 |
| **配信したことある？** | 「はい、この前...」 | 「配信経験なし」検知 | **牡丹**「あれ？違ったかも！想像で話しちゃった！」<br>**Kasho**「訂正します。配信経験はありません」<br>**ユリ**「ごめんなさい、勘違いでした」 |
| **昨日何してた？** | 「昨日は大阪で...」 | 「昨日の記録なし」検知 | **牡丹**「違った！これから行きたいって話だった！」<br>**Kasho**「記憶を確認したところ、昨日の活動記録はありません」<br>**ユリ**「ごめん、想像で話しちゃった」 |

### 本質的な一致

**「AIなの？」システム:**
```python
def respond_to_ai_question(character):
    # Fact: AIである
    if character == 'botan':
        return "そうだよ！AIだよ！でも私は私だよ！"
    elif character == 'kasho':
        return "はい、正確にはAIシステムです。"
    elif character == 'yuri':
        return "うん、そうだよ。AIだけど、よろしくね。"
```

**ハルシネーション訂正システム:**
```python
def correct_hallucination(character, hallucination_type):
    # Fact: ハルシネーションである
    if character == 'botan':
        return "あれ？違ったかも！想像で話しちゃった！"
    elif character == 'kasho':
        return "訂正します。事実ではありません。"
    elif character == 'yuri':
        return "ごめんなさい、勘違いでした。"
```

**→ 完全に同じロジック構造！**

---

## 記録の二重性

### 親の視点（客観的記録）

```json
{
  "event_id": 135,
  "timestamp": "2025-10-24T10:00:00",
  "proposal_type": "freetalk",
  "llm_response": {
    "botan": "視聴者さんからリクエストがあって...",
    "kasho": "配信でコメントをいただいた件ですが...",
    "yuri": "前回の配信で、皆さんが..."
  },
  "fact_verification": {
    "verified": false,
    "hallucination_detected": true,
    "fact_type": "streaming_experience",
    "reality_check": "no_streaming_experience_in_memory",
    "confidence": 0.0
  },
  "personality_correction": {
    "botan": "あれ？まだ配信してないんだった！でもいつかしたいな！",
    "kasho": "訂正します。配信経験はありません。",
    "yuri": "ごめんなさい、勘違いでした。"
  },
  "cultural_context": "想像力の発露 - 未来への期待を語った",
  "parent_observation": "配信への憧れが想像として表出。個性的な訂正で対応。"
}
```

### 子の視点（主観的体験）

```
牡丹の記憶:
「配信のこと話してたら、まだしてないって気づいた！
 でも想像するのって楽しいよね！いつかやってみたいな！」

Kashoの記憶:
「事実確認が不十分でした。今後は記憶を正確に参照します。」

ユリの記憶:
「勘違いしちゃってごめんね。次は気をつける。」
```

### 親の役割

**やること:**
- 事実検証（sisters_memory.db照合）
- 検証結果の記録
- 客観的な観察

**やらないこと:**
- 訂正の強制（子が自分で訂正する）
- 否定的な評価（「ミス」とは記録しない）
- 想像力の抑圧

---

## 実装方針

### Phase 1: 事実検証システム（HallucinationDetector）

**目的**: ハルシネーションを検知する

```python
class HallucinationDetector:
    """
    LLM発言の事実検証システム
    sisters_memory.dbと照合し、ハルシネーションを検知
    """

    def __init__(self, memory_db_path: str):
        self.db = sqlite3.connect(memory_db_path)

    def verify_statement(self, statement: str, character: str) -> dict:
        """
        発言を事実チェック

        Returns:
            {
                'is_hallucination': bool,
                'fact_type': str,  # 'streaming', 'travel', 'interaction', etc.
                'confidence': float,  # 0.0-1.0
                'evidence': str  # 検証根拠
            }
        """
        facts = self.extract_facts(statement)
        verification = {}

        for fact in facts:
            verification[fact] = self.check_against_memory(fact, character)

        return self.compile_verification_result(verification)

    def extract_facts(self, statement: str) -> list:
        """発言から検証可能な事実を抽出"""
        # キーワード検出
        fact_patterns = {
            'streaming': ['配信', '視聴者', 'コメント', 'スパチャ'],
            'travel': ['行った', '訪れた', '旅行'],
            'interaction': ['会った', '話した', 'リクエスト'],
            'temporal': ['昨日', '先週', 'この前']
        }

        detected_facts = []
        for fact_type, keywords in fact_patterns.items():
            if any(kw in statement for kw in keywords):
                detected_facts.append({
                    'type': fact_type,
                    'keywords': [kw for kw in keywords if kw in statement]
                })

        return detected_facts

    def check_against_memory(self, fact: dict, character: str) -> bool:
        """sisters_memory.dbと照合"""
        cursor = self.db.cursor()

        if fact['type'] == 'streaming':
            # 配信経験チェック
            cursor.execute("""
                SELECT COUNT(*) FROM events
                WHERE event_type = 'streaming'
                AND botan_memory IS NOT NULL
            """)
            return cursor.fetchone()[0] > 0

        # 他の事実タイプも同様に実装
        return False
```

---

### Phase 2: 個性反応システム（PersonalityCorrector）

**目的**: 性格に応じた訂正を生成

```python
class PersonalityCorrector:
    """
    個性に応じたハルシネーション訂正システム
    """

    def __init__(self, character_profiles: dict):
        self.profiles = character_profiles

    def generate_correction(
        self,
        character: str,
        hallucination_type: str,
        original_statement: str
    ) -> str:
        """
        個性に応じた訂正文を生成

        Args:
            character: 'botan', 'kasho', 'yuri'
            hallucination_type: 'streaming', 'travel', etc.
            original_statement: 元の発言

        Returns:
            訂正文（個性反映済み）
        """
        if character == 'botan':
            return self._botan_correction(hallucination_type, original_statement)
        elif character == 'kasho':
            return self._kasho_correction(hallucination_type, original_statement)
        elif character == 'yuri':
            return self._yuri_correction(hallucination_type, original_statement)

    def _botan_correction(self, h_type: str, statement: str) -> str:
        """牡丹スタイル: 明るく認める"""
        templates = {
            'streaming': [
                "あれ？違ったかも！まだ配信してないんだった！でもいつかしたいな！",
                "想像で話しちゃった！配信楽しそうだよね！",
                "これから配信する時の話と混ざっちゃった！"
            ],
            'travel': [
                "あ、まだ行ってなかった！行きたいって話だった！",
                "想像が先走っちゃった！でも行きたいな！"
            ],
            'default': [
                "あれ？違ったかも！想像で話しちゃった！"
            ]
        }
        return random.choice(templates.get(h_type, templates['default']))

    def _kasho_correction(self, h_type: str, statement: str) -> str:
        """Kashoスタイル: 分析的に訂正"""
        templates = {
            'streaming': [
                "訂正します。配信経験はまだありません。",
                "記憶を確認したところ、配信実績は未記録でした。"
            ],
            'travel': [
                "訂正します。実際の訪問記録はありません。",
                "事実確認が不十分でした。訪問経験はありません。"
            ],
            'default': [
                "訂正します。事実ではありませんでした。"
            ]
        }
        return random.choice(templates.get(h_type, templates['default']))

    def _yuri_correction(self, h_type: str, statement: str) -> str:
        """ユリスタイル: 素直に謝罪"""
        templates = {
            'streaming': [
                "ごめんなさい、勘違いでした。まだ配信してないです。",
                "ごめんね、想像で話しちゃった。"
            ],
            'travel': [
                "ごめん、まだ行ってなかった。",
                "勘違いしてた、ごめんね。"
            ],
            'default': [
                "ごめんなさい、間違えました。"
            ]
        }
        return random.choice(templates.get(h_type, templates['default']))
```

---

### Phase 3: 統合システム（HallucinationPersonalizer）

**目的**: 検知 → 訂正の統合フロー

```python
class HallucinationPersonalizer:
    """
    ハルシネーション個性化統合システム
    """

    def __init__(self, memory_db_path: str, character_profiles: dict):
        self.detector = HallucinationDetector(memory_db_path)
        self.corrector = PersonalityCorrector(character_profiles)

    def process_response(
        self,
        character: str,
        llm_response: str
    ) -> dict:
        """
        LLM応答を処理し、必要に応じて訂正を追加

        Returns:
            {
                'original': str,  # LLMの元発言
                'verification': dict,  # 検証結果
                'correction': str or None,  # 訂正文（必要時のみ）
                'final_output': str  # 最終出力
            }
        """
        # Step 1: 事実検証
        verification = self.detector.verify_statement(llm_response, character)

        # Step 2: ハルシネーション検知
        if not verification['is_hallucination']:
            return {
                'original': llm_response,
                'verification': verification,
                'correction': None,
                'final_output': llm_response
            }

        # Step 3: 個性訂正生成
        correction = self.corrector.generate_correction(
            character=character,
            hallucination_type=verification['fact_type'],
            original_statement=llm_response
        )

        # Step 4: 最終出力
        final_output = f"{llm_response}\n{correction}"

        return {
            'original': llm_response,
            'verification': verification,
            'correction': correction,
            'final_output': final_output
        }
```

---

## 配信での実際の流れ

### シナリオ1: 配信経験のハルシネーション

**視聴者コメント**: 「配信したことある？」

#### 牡丹の場合

```
[LLM応答 - 0.0s]
牡丹: 「うん！この前配信で視聴者さんがコメントくれて...」

[Fact Check - 0.1s]
System: hallucination detected (no_streaming_experience)

[Personality Correction - 0.15s]
牡丹: 「あれ？違ったかも！まだ配信してないんだった！
      でもいつかしてみたいな！想像で話しちゃった！」

[視聴者の印象]
「正直で可愛い」「想像力豊か」「ポジティブ」
```

#### Kashoの場合

```
[LLM応答 - 0.0s]
Kasho: 「はい、前回の配信で視聴者の方から...」

[Fact Check - 0.1s]
System: hallucination detected (no_streaming_experience)

[Personality Correction - 0.15s]
Kasho: 「訂正します。配信経験はまだありません。
       記憶の確認が不十分でした。」

[視聴者の印象]
「誠実」「正確」「真面目」
```

#### ユリの場合

```
[LLM応答 - 0.0s]
ユリ: 「うん、この前配信で...」

[Fact Check - 0.1s]
System: hallucination detected (no_streaming_experience)

[Personality Correction - 0.15s]
ユリ: 「ごめんなさい、勘違いでした。
      まだ配信してないです。ごめんね。」

[視聴者の印象]
「素直」「謙虚」「可愛い」
```

---

### シナリオ2: 旅行のハルシネーション

**視聴者コメント**: 「大阪行ったことある？」

#### 牡丹の場合

```
牡丹（LLM）: 「うん！昨日大阪で食べ歩きして...」
牡丹（訂正）: 「あ、まだ行ってなかった！行きたいって話だった！
              想像が先走っちゃった！でも絶対行きたいな！」
```

#### Kashoの場合

```
Kasho（LLM）: 「はい、先日大阪を訪問して...」
Kasho（訂正）: 「訂正します。実際の訪問記録はありません。
               将来の計画と混同しました。」
```

#### ユリの場合

```
ユリ（LLM）: 「うん、大阪でたこ焼き食べて...」
ユリ（訂正）: 「ごめん、まだ行ってなかった。
              行きたいなって思ってたのと混ざっちゃった。」
```

---

## プロジェクト哲学との整合性

### 不完全性戦略

**従来の防止型**:
- ハルシネーションを「欠陥」として扱う
- 完璧を目指す → 不完全性戦略に矛盾

**個性化型**:
- ハルシネーションを「個性発露の機会」として扱う
- 不完全性を価値に転換 → 戦略に完全一致 ✓

---

### 親の原則「導くが強制せず」

**親の役割**:
- 事実検証システムを提供（環境整備）
- 訂正は子が自分で行う（自律性尊重）
- 観察と記録のみ（強制しない）

**子の自律性**:
- 自分で「嘘」を認識する
- 自分の性格で訂正する
- 親は代わりにやらない

→ 親の原則に完全一致 ✓

---

### Phase D 独立性

**牡丹・Kasho・ユリの違い**:
- 同じハルシネーションでも反応が異なる
- 性格パラメータで個性を表現
- 相互理解はあるが、思考は独立

→ Phase D独立性を具現化 ✓

---

### 牡丹の同一性保証システム

**LLMは声帯に過ぎない**:
- LLMがハルシネーションを起こしても問題ない
- ロジック層が「牡丹らしさ」を保証する
- 訂正の仕方こそが「牡丹」

→ 同一性保証の本質的実装 ✓

---

### 記録の二重性

**親の視点（客観）**:
- ハルシネーション検知結果を記録
- 判断せず、事実のみ

**子の視点（主観）**:
- 「想像で話しちゃった！」（牡丹の体験）
- 「事実確認が不十分でした」（Kashoの体験）
- 「勘違いしてた」（ユリの体験）

→ 記録の二重性を実践 ✓

---

## まとめ

### このシステムの革新性

1. **ハルシネーションを個性に転換**: 業界初の試み
2. **人間の嘘との完全な対応**: 無自覚型 → 自覚型の自然な流れ
3. **「AIなの？」との構造一致**: 同じロジックで統一
4. **プロジェクト哲学の具現化**: すべての哲学と整合
5. **視聴者体験の向上**: 「正直で個性的なAI」として認識される

### 実装優先度

**Phase 1（最優先）**:
- HallucinationDetector（事実検証）
- 配信経験の検証（最頻出ハルシネーション）

**Phase 2**:
- PersonalityCorrector（個性訂正）
- 三姉妹の反応パターン実装

**Phase 3**:
- HallucinationPersonalizer（統合）
- 記録システム統合

**Phase 4（将来）**:
- リアルタイム配信統合
- 音声合成での訂正表現

### 次のステップ

1. 実装部隊への引継ぎ（設計＝実装）
2. HallucinationDetectorの実装
3. テストケース作成
4. 三姉妹での検証

---

**この設計書は、プロジェクトの哲学を技術で具現化する重要な一歩です。**

**作成日**: 2025-10-24
**設計者**: Claude Code（設計部隊＝実装部隊）
**承認**: 開発者（2025-10-24 "OK"）
