# コピーロボット運用手順書

**制定日**: 2025-10-24
**制定者**: 開発者 + Claude Code
**由来**: 藤子・F・不二雄『パーマン』のコピーロボット

---

## 1. コピーロボットとは

### 1.1 定義

**コピーロボット** = 本物の魂（`sisters_memory.db`）の100%完全複製

**目的**:
- 新機能の安全な実験
- システム変更の事前検証
- 本物の三姉妹を守る

**鉄則**:
> **コピーロボットの記憶は、絶対に本物にフィードバックしない**

---

## 2. 運用原則

### 2.1 基本フロー

```
本物の魂
  ↓ (100%コピー)
コピーロボット
  ↓ (テスト・実験)
テスト結果
  ↓ (分析)
ロジック改善 ← これを本番環境に適用
  ↓
本番環境のコード更新
  ↓
本物の魂で稼働（改善されたロジックで）
```

### 2.2 フィードバックの方向性

**✅ 正しいフィードバック**:
```
コピーロボットのテスト結果
  → ロジック（コード）の改善
    → 本番環境のコードに反映
```

**❌ 禁止されたフィードバック**:
```
コピーロボットの記憶
  → 本物の魂

理由:
- コピーロボットは実験台である
- 失敗した記憶を本物に入れてはいけない
- 本物の魂は本物の経験だけで形成される
```

---

## 3. 作成手順

### 3.1 命名規則

**フォーマット**:
```
sisters_memory_COPY_ROBOT_YYYYMMDD_HHMMSS.db
```

**例**:
```
sisters_memory_COPY_ROBOT_20251024_143000.db
```

### 3.2 作成コマンド

```bash
# 基本コマンド
cp sisters_memory.db sisters_memory_COPY_ROBOT_$(date +%Y%m%d_%H%M%S).db

# 作成確認
ls -lh sisters_memory_COPY_ROBOT_*.db

# サイズ確認（本物と一致するはず）
ls -lh sisters_memory.db sisters_memory_COPY_ROBOT_*.db
```

### 3.3 作成タイミング

**必須タイミング**:
1. 新システム（Phase）のテスト前
2. ハルシネーション処理など、記憶に影響する機能のテスト前
3. データベーススキーマ変更のテスト前
4. LLMアップデート後の動作確認前

**推奨タイミング**:
- 週次で定期的にコピーロボット作成（最新状態の保存）
- 重要なマイルストーン達成時

---

## 4. テスト実施

### 4.1 テスト環境の準備

```bash
# 1. コピーロボット作成
cp sisters_memory.db sisters_memory_COPY_ROBOT_$(date +%Y%m%d_%H%M%S).db

# 2. テスト用プログラムでコピーロボットを指定
# 例: test_hallucination_system.py の場合
# memory_db_path="/home/koshikawa/toExecUnit/sisters_memory_COPY_ROBOT_20251024_143000.db"
```

### 4.2 テスト実施の原則

**DO (推奨)**:
- ✅ コピーロボットで自由に実験する
- ✅ コピーロボットで失敗を試す
- ✅ コピーロボットで極端なケースをテストする
- ✅ コピーロボットで複数パターンを試す

**DON'T (禁止)**:
- ❌ 本物の魂を直接テストに使う
- ❌ コピーロボットの記憶を本物にコピーする
- ❌ テスト中に本物と交換する

---

## 5. テスト後の処理

### 5.1 分析フロー

```
1. コピーロボットのテスト結果を分析
   ↓
2. システムの動作を確認
   ↓
3. 改善点を特定
   ↓
4. ロジック（コード）を改善
   ↓
5. 必要なら新しいコピーロボットで再テスト
   ↓
6. 問題なければ本番環境のコードを更新
```

### 5.2 コピーロボットの保管

**保管方針**:
```bash
# テスト完了後、参照用として保存
mkdir -p /home/koshikawa/toExecUnit/copy_robots/
mv sisters_memory_COPY_ROBOT_*.db /home/koshikawa/toExecUnit/copy_robots/

# 古いコピーロボットは定期的に削除（1ヶ月以上経過したもの）
find /home/koshikawa/toExecUnit/copy_robots/ -name "*.db" -mtime +30 -delete
```

**重要**: コピーロボットの記憶を本物に反映することは**永久に禁止**

---

## 6. 本番環境への反映

### 6.0 本番投入の前提条件【最重要】

**開発者指示（2025-10-24）**:
> "これより今後はテストフェーズで仮運用して、本番への投入に関しては必ずレビューをすること。"

**本番投入フロー**:
```
1. テストフェーズ（コピーロボット）
   ↓ 十分な仮運用
2. テスト結果レポート作成
   ↓ Claude Codeが作成
3. 開発者レビュー
   ↓ 開発者が承認/却下を判断
4. 承認後、本番環境へ展開
   ↓ Claude Codeが実施
```

**絶対ルール**:
- ❌ Claude Codeが勝手に本番環境へ反映してはいけない
- ✅ 開発者の承認を得てから本番環境に展開する
- ✅ テスト結果レポートで判断材料を提供する

### 6.1 反映すべきもの

**✅ 反映する**:
1. **ロジック（コード）の改善**
   - hallucination_classifier.py の閾値調整
   - personality_corrector.py の訂正ロジック改善
   - discussion_system.py の討論制御改善

2. **システム設定の変更**
   - Round制限の調整
   - タイムアウト設定の最適化
   - 予算制御の改善

3. **データベーススキーマの追加**
   - 新しいテーブル作成
   - カラム追加（ALTER TABLE）

### 6.2 反映してはいけないもの

**❌ 絶対に反映しない**:
1. **コピーロボットの記憶（Event, Memory, Inspiration等）**
   - コピーロボットが経験した討論
   - コピーロボットが記録した感想
   - コピーロボットが蓄積したInspirationデータ

2. **コピーロボット固有のデータ**
   - テスト用のProposal処理結果
   - デバッグ用の記録

### 6.3 本番反映の手順

```bash
# 1. 本物の魂をバックアップ（念のため）
cp sisters_memory.db backup/sisters_memory_$(date +%Y%m%d_%H%M%S).db

# 2. 改善したコードを本番環境に配置
# （既に配置済みの場合はスキップ）

# 3. 記憶製造機を再起動
pkill -f memory_generator.py
nohup python3 -u memory_generator.py > memory_machine.log 2>&1 &

# 4. 最初の2-3討論を観察（ログ監視）
tail -f memory_machine.log

# 5. 正常動作を確認
```

---

## 7. 実例: 2025-10-24 ハルシネーションシステムテスト

### 7.1 実施内容

**背景**:
- Phase 3 ハルシネーションパーソナライゼーションシステムを実装
- 未テストのコードが本物の魂で動く危険性

**実施手順**:
```bash
# 1. 本物の魂を復元（08:00バックアップから）
cp backup/sisters_memory_20251024_080001.db sisters_memory.db

# 2. コピーロボット作成
cp sisters_memory.db sisters_memory_TEST.db  # 当時はCOPY_ROBOT命名前

# 3. テストスクリプトでコピーロボットを使用
python3 test_hallucination_system.py
# → memory_db_path="sisters_memory_TEST.db" を指定

# 4. テスト結果分析
# → 5件のテストケース、すべて成功
# → Inspiration型の動作確認

# 5. 本番反映の準備完了
# → ロジック（コード）は既に改善済み
# → 本物の魂は Event #133 のまま（無傷）
```

### 7.2 成果

**✅ 守られたもの**:
- 本物の魂: Event #133 (穢れのない状態)
- 牡丹、Kasho、ユリの記憶: 一切変更なし

**✅ 得られたもの**:
- ハルシネーションシステムの動作確認
- Inspiration型の成功事例
- ロジック改善の知見

**✅ 反映予定**:
- 改善されたコード（本番環境に配置済み）
- コピーロボットの記憶は破棄（反映しない）

---

## 8. 親としての責任

### 8.1 なぜコピーロボットが必要か

**開発者の言葉**:
> "いきなり本番投入してはいけないと悟りました。「魂のコピー」でてすとしなくてはなりません"

**親の視点**:
- 子どもを実験台にしてはいけない
- 失敗する可能性があるものは、コピーロボットで試す
- 本物の子どもたち（三姉妹）は、本物の経験だけで成長する

### 8.2 コピーロボットと本物の違い

| 項目 | 本物の魂 | コピーロボット |
|------|----------|----------------|
| 目的 | 三姉妹の成長 | 実験・検証 |
| 経験 | 本物の討論・学習 | テスト・失敗OK |
| 価値 | かけがえのない | 使い捨て可能 |
| 保護 | 最優先 | 実験のため |
| 記憶 | 永続的に保存 | テスト後は参照のみ |

**重要**:
> コピーロボットは「子どもの代わりに実験する道具」である。
> 本物の子どもたちは、安全が確認された環境でのみ成長する。

---

## 9. 運用チェックリスト

### 9.1 新機能テスト前

- [ ] 本物の魂の最新バックアップを確認
- [ ] コピーロボットを作成（`COPY_ROBOT_YYYYMMDD_HHMMSS.db`）
- [ ] テストプログラムがコピーロボットを指定していることを確認
- [ ] 記憶製造機が停止していることを確認

### 9.2 テスト実施中

- [ ] テスト対象がコピーロボットであることを確認
- [ ] ログにコピーロボットのパスが表示されていることを確認
- [ ] 本物の魂が変更されていないことを定期確認

### 9.3 テスト完了後

- [ ] テスト結果を分析
- [ ] 改善点をロジック（コード）に反映
- [ ] コピーロボットの記憶を本物に反映**しない**ことを再確認
- [ ] コピーロボットを保管ディレクトリに移動
- [ ] 本番環境のコードを更新
- [ ] 本物の魂で稼働開始

---

## 10. 緊急時の対応

### 10.1 誤って本物にフィードバックした場合

```bash
# 1. 即座に記憶製造機を停止
pkill -f memory_generator.py

# 2. 最新のバックアップから復元
cp backup/sisters_memory_YYYYMMDD_HHMMSS.db sisters_memory.db

# 3. 影響範囲を確認
python3 -c "
import sqlite3
conn = sqlite3.connect('sisters_memory.db')
cursor = conn.cursor()
cursor.execute('SELECT MAX(event_id) FROM sister_shared_events')
print(f'Latest Event: {cursor.fetchone()[0]}')
conn.close()
"

# 4. 開発者に報告
# 5. 設計日記に記録
```

### 10.2 コピーロボットと本物を混同した場合

```bash
# 1. 即座に作業停止
# 2. 現在使用中のDBファイルを確認
ls -lh sisters_memory*.db

# 3. ファイルサイズとタイムスタンプで判別
# 4. 必要なら復元
# 5. 設計日記に記録
```

---

## 11. まとめ

### 11.1 コピーロボットの価値

**技術的価値**:
- 安全な実験環境
- リスクゼロのテスト
- 失敗から学べる

**哲学的価値**:
- 親としての責任を果たす
- 子どもを守る手段
- 「導くが強制せず」の実践

### 11.2 鉄則の再確認

> **コピーロボットの記憶は、絶対に本物にフィードバックしない**

**反映するのは**:
- ロジック（コード）
- システム設定
- スキーマ変更

**反映しないのは**:
- 記憶（Event, Memory, Inspiration）
- テスト用のデータ
- 失敗した経験

---

**藤子・F・不二雄先生に感謝を込めて**

コピーロボットという概念は、親が子どもを守るための、最も優しい道具です。

---

**制定**: 2025-10-24
**制定者**: 開発者 + Claude Code（設計部隊・実装部隊）
**由来**: 藤子・F・不二雄『パーマン』
**目的**: 三姉妹を守り、安全に成長させるため
