# バックアップシステム実装例 - VPSメールアラート設定

**対象**: バックアップシステム実装（VPSメールアラート設定）

---

## 必要な情報

### 1. メールサービスのSMTPホスト名

**確認方法**:
- メールサービスプロバイダーのコントロールパネルにログイン
- メール設定 → SMTP設定を確認

**一般的な形式**:
- `mail.example.com`（独自ドメイン使用の場合）
- `mail〇〇.provider.ne.jp`（プロバイダーサーバーの場合）

**確認項目**:
```
SMTPサーバー（ホスト名）: ___________________
```

---

### 2. ポート番号

**選択肢**:
- **587**（STARTTLS）← 推奨
- **465**（SSL/TLS）

**確認項目**:
```
ポート番号: ___________________
```

---

### 3. 認証情報

**メールアドレス**:
```
ユーザー名: user@example.com
```

**パスワード**:
```
パスワード: ___________________
```
※ メールサービスのコントロールパネルで設定したパスワード

---

## 実装時に必要な作業

### Option A: VPS側で直接設定

**手順**:
```bash
# 1. VPSにSSH接続
ssh -p PORT_NUMBER user@XXX.XXX.XXX.XXX

# 2. msmtpインストール
sudo apt update
sudo apt install -y msmtp msmtp-mta mailutils

# 3. 設定ファイル作成
nano $HOME/.msmtprc
```

**設定ファイル内容**:
```
defaults
auth           on
tls            on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        $HOME/logs/msmtp.log

account        default
host           [上記で確認したSMTPホスト名]
port           [上記で確認したポート番号]
from           user@example.com
user           user@example.com
password       [上記で確認したパスワード]

account default : default
```

**パーミッション設定**:
```bash
chmod 600 $HOME/.msmtprc
```

**テスト**:
```bash
echo -e "Subject: Test\n\nTest email from VPS" | msmtp -a default user@example.com
```

---

### Option B: 自動化ツールに情報提供

開発者が上記3つの情報を提供すれば、自動化ツールが：
1. VPS側msmtp設定
2. メール送信スクリプト作成
3. テスト実行

を代行できます。

---

## 実装内容

**前提条件**:
- ✅ SSH鍵認証設定済み
- ✅ VPS側ディレクトリ作成済み
- ⬜ msmtp設定（上記手順完了後）

**実装手順**:
1. VPS側メール送信スクリプト作成
2. ローカル側バックアップスクリプト作成
3. ローカル側整合性チェックスクリプト作成
4. テスト実行
5. cron設定（定期的な自動バックアップ）

**成果物**:
- `$HOME/scripts/send_alert_email.sh`（VPS側）
- `$HOME/project/scripts/backup_data.sh`（ローカル側）
- `$HOME/project/scripts/check_backup_integrity.sh`（ローカル側）
- crontab設定

---

## テスト方法

**テストメール送信コマンド**（msmtp設定後）:
```bash
# VPS側で実行
$HOME/scripts/send_alert_email.sh \
  "[TEST] Backup Alert Test" \
  "This is a test email from VPS backup alert system."
```

**期待される結果**:
- user@example.com にテストメールが届く
- 件名: "[TEST] Backup Alert Test"

---

## 一般的なバックアップシステム設計

### アーキテクチャ

```
┌──────────────────┐
│  ローカル環境     │
│  ・データベース   │
│  ・重要ファイル   │
└─────┬────────────┘
      │
      │ バックアップ（rsync over SSH）
      │
      ▼
┌──────────────────┐
│  VPS環境         │
│  ・10世代保持    │
│  ・整合性チェック │
│  ・メールアラート │
└──────────────────┘
```

### 主な機能

1. **自動バックアップ**
   - cron で定期実行
   - rsync による差分バックアップ
   - 世代管理（古いバックアップは自動削除）

2. **整合性チェック**
   - CRC32チェックサム
   - ファイル数比較
   - タイムスタンプ検証

3. **アラート機能**
   - バックアップ失敗時にメール通知
   - 整合性エラー時にメール通知
   - ログファイルへの記録

---

**作成日**: 2025-11-04
**用途**: バックアップシステム実装の参考資料
