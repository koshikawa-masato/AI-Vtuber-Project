# フリートーク議題システム実装仕様書

**作成日**: 2025-10-24
**作成者**: Claude Code（設計部隊）
**対象**: 実装部隊
**優先度**: 高

---

## 概要

ハルシネーション事件（Event #135, #133, #130, #129）を受けて、フリートーク議題の管理体制を刷新。

**変更点:**
1. 既存の `DynamicThemeGenerator` を `FreetalkTopicSelector` に置き換え
2. LLMによる動的生成から、事前定義プールからの選択方式に変更
3. 10議題ごとに autonomous_topics（内側からの刺激）を自動挿入
4. 1回使い切り方式（同じ議題は二度と使わない）

---

## ファイル構成

### 新規ファイル
- `/home/koshikawa/toExecUnit/freetalk_topics_pool.json` (既存)
  - 120議題（10カテゴリ × 12議題）
  - autonomous_topics 10種類
  - 使用済み議題リスト（used_topics）

### 修正ファイル
- `/home/koshikawa/toExecUnit/memory_generator.py`
  - `DynamicThemeGenerator` クラスを削除
  - `FreetalkTopicSelector` クラスを新規作成
  - `auto_propose_free_talk()` メソッドを修正

---

## 詳細設計

### 1. FreetalkTopicSelector クラス

**ファイル**: `memory_generator.py`
**場所**: 148行目付近（DynamicThemeGeneratorを置き換え）

#### 1.1 クラス構造

```python
class FreetalkTopicSelector:
    """
    Select free talk topics from predefined pool.
    Replaces DynamicThemeGenerator.

    Features:
    - One-time use (each topic used only once)
    - Auto-insert autonomous_topics every 10 topics
    - Alert when remaining topics < 20
    """

    def __init__(self, pool_filepath: str = "/home/koshikawa/toExecUnit/freetalk_topics_pool.json"):
        self.pool_filepath = pool_filepath
        self.topic_counter = 0  # Count topics used (for autonomous trigger)
        self._ensure_pool_exists()

    def _ensure_pool_exists(self):
        """Verify freetalk_topics_pool.json exists"""
        # Check file exists
        # If not, raise error (pool must be created by design team)

    def _load_pool(self) -> dict:
        """Load freetalk_topics_pool.json"""
        # Load JSON file
        # Return dict

    def _save_pool(self, data: dict):
        """Save freetalk_topics_pool.json"""
        # Save JSON file with proper formatting

    def get_remaining_count(self) -> int:
        """Get count of remaining unused topics"""
        # Calculate: total topics - used topics
        # Return count

    def should_use_autonomous(self) -> bool:
        """Check if should use autonomous_topic (every 10 topics)"""
        # Check if topic_counter % 10 == 0
        # Return True/False

    def select_autonomous_topic(self) -> dict:
        """Select next autonomous_topic (rotation)"""
        # Load pool
        # Get current rotation_index
        # Select topics[rotation_index]
        # Increment rotation_index (mod 10)
        # Save pool
        # Return topic dict

    def select_regular_topic(self) -> dict:
        """Select random topic from unused pool"""
        # Load pool
        # Get all unused topics (filter out used_topics)
        # Select random category
        # Select random unused topic from that category
        # Add to used_topics
        # Save pool
        # Return topic dict

    def select_topic(self) -> dict:
        """
        Main entry point: select topic (regular or autonomous)

        Returns:
            dict with keys:
            - 'theme': topic title
            - 'reason': reason for selection
            - 'expected_style': discussion style
            - 'type': 'regular' or 'autonomous'
            - 'initiator': (for autonomous only)
            - 'target': (for autonomous only)
        """
        # Increment topic_counter

        # Check if should use autonomous
        if self.should_use_autonomous():
            return self.select_autonomous_topic()

        # Otherwise select regular topic
        return self.select_regular_topic()

    def check_and_alert_low_topics(self):
        """Alert if remaining topics < threshold"""
        # Get remaining count
        # If < alert_threshold (20):
        #   Print warning message to developer
```

#### 1.2 データ構造

**戻り値の例（regular topic）:**
```python
{
    'theme': '今日はどんな気分？何か嬉しいことあった？',
    'reason': 'カテゴリ「日常・感情」から選択。親が事前に決めた情報のみで議題生成。',
    'expected_style': 'relaxed',
    'type': 'regular',
    'category': 'daily_life_emotions'
}
```

**戻り値の例（autonomous topic）:**
```python
{
    'theme': 'ユリ、話したいことある？',
    'reason': '10議題ごとの内側からの刺激。牡丹がユリに話したいことを尋ねる。',
    'expected_style': 'playful',
    'type': 'autonomous',
    'initiator': 'botan',
    'target': 'yuri'
}
```

---

### 2. memory_generator.py の修正

#### 2.1 インポート部分（17-32行目付近）

**削除:**
```python
# 何も削除しない（既存のimportはそのまま）
```

**変更なし** - 新しいクラスは同じファイル内に定義

#### 2.2 DynamicThemeGenerator クラス（148-350行目付近）

**削除:**
```python
class DynamicThemeGenerator:
    # 全体を削除
```

**置き換え:**
```python
class FreetalkTopicSelector:
    # 上記の1.1の実装
```

#### 2.3 MemoryManufacturingMachine クラス（800行目付近）

**初期化部分の修正:**

**Before:**
```python
self.theme_generator = DynamicThemeGenerator(model="qwen2.5:32b")
```

**After:**
```python
self.topic_selector = FreetalkTopicSelector()
```

#### 2.4 auto_propose_free_talk() メソッド（886-916行目）

**Before:**
```python
async def auto_propose_free_talk(self):
    """Auto-generate free talk proposal (6hr timer)"""

    print("\n{'='*70}")
    print("Auto Free Talk Proposal Generation")
    print("{'='*70}\n")

    # Generate dynamic theme
    theme_data = await self.theme_generator.generate_theme(self.proposal_manager)

    print(f"Generated theme: {theme_data['theme']}")
    print(f"Reason: {theme_data['reason']}")
    print(f"Style: {theme_data['expected_style']}\n")

    # Create proposal
    next_id = self.proposal_manager.get_next_event_id()

    proposal = Proposal(
        id=next_id,
        priority="auto",
        status="pending",
        title=theme_data['theme'],
        description=f"フリートーク（6時間タイマー）\n理由: {theme_data['reason']}\nスタイル: {theme_data['expected_style']}",
        created_at=datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    )

    self.proposal_manager.add_proposal(proposal)
    self.proposal_manager.increment_event_id()  # Increment next_event_id
    self.proposal_manager.update_last_auto_proposal()

    print(f"✅ Auto proposal #{next_id} created!\n")
```

**After:**
```python
def auto_propose_free_talk(self):  # async不要
    """Auto-generate free talk proposal (6hr timer)"""

    print("\n" + "="*70)
    print("Auto Free Talk Proposal Generation")
    print("="*70 + "\n")

    # Check remaining topics and alert if low
    self.topic_selector.check_and_alert_low_topics()

    # Select topic from pool
    topic_data = self.topic_selector.select_topic()

    # Display selected topic
    print(f"Selected topic: {topic_data['theme']}")
    print(f"Type: {topic_data['type']}")
    print(f"Reason: {topic_data['reason']}")
    print(f"Style: {topic_data['expected_style']}")

    if topic_data['type'] == 'autonomous':
        print(f"Initiator: {topic_data['initiator']} → Target: {topic_data['target']}")

    print()

    # Create proposal
    next_id = self.proposal_manager.get_next_event_id()

    # Build description
    description = f"フリートーク（6時間タイマー）\n"
    description += f"タイプ: {topic_data['type']}\n"
    description += f"理由: {topic_data['reason']}\n"
    description += f"スタイル: {topic_data['expected_style']}"

    if topic_data['type'] == 'autonomous':
        description += f"\n発起人: {topic_data['initiator']} → 対象: {topic_data['target']}"

    proposal = Proposal(
        id=next_id,
        priority="auto",
        status="pending",
        title=topic_data['theme'],
        description=description,
        created_at=datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    )

    self.proposal_manager.add_proposal(proposal)
    self.proposal_manager.increment_event_id()
    self.proposal_manager.update_last_auto_proposal()

    print(f"✅ Auto proposal #{next_id} created!\n")
```

#### 2.5 run() メソッド（970-1020行目付近）

**修正箇所:**

**Before:**
```python
if self.is_idle() and self.should_auto_propose():
    print("[INFO] Idle for 6+ hours. Generating auto free talk...\n")
    await self.auto_propose_free_talk()
```

**After:**
```python
if self.is_idle() and self.should_auto_propose():
    print("[INFO] Idle for 6+ hours. Generating auto free talk...\n")
    self.auto_propose_free_talk()  # awaitを削除（asyncではなくなった）
```

---

## 実装アルゴリズム詳細

### 議題選択ロジック

```
1. topic_counter をインクリメント

2. topic_counter % 10 == 0 ?
   YES → autonomous_topic を選択
     - rotation_index 番目の autonomous_topic を取得
     - rotation_index を (rotation_index + 1) % 10 に更新
     - pool を保存
     - topic_data を返す

   NO → regular_topic を選択
     - pool を読み込み
     - used_topics を除外した未使用議題リストを作成
     - 未使用議題が0件？
       YES → エラー（議題プール枯渇、開発者に通知）
       NO → 続行
     - ランダムにカテゴリを選択
     - そのカテゴリから未使用議題をランダムに1つ選択
     - used_topics に追加
     - pool を保存
     - topic_data を返す

3. 残り議題数をチェック
   - remaining < alert_threshold (20) ?
     YES → 開発者に警告メッセージを表示

4. topic_data を返す
```

### 使用済み議題の記録

**freetalk_topics_pool.json の used_topics:**
```json
{
  "used_topics": [
    {
      "topic": "今日はどんな気分？何か嬉しいことあった？",
      "category": "daily_life_emotions",
      "used_at": "2025-10-24 10:30:15",
      "event_id": 136
    },
    {
      "topic": "一番好きな食べ物は何？",
      "category": "food",
      "used_at": "2025-10-24 16:45:22",
      "event_id": 137
    }
  ]
}
```

### autonomous_topics のローテーション

**rotation_index の管理:**
- 初期値: 0
- 使用後: (rotation_index + 1) % 10
- autonomous_topics は10種類なので、10回のローテーションで1周

**例:**
```
議題1-10 (regular)
  ↓ topic_counter = 10
autonomous #0: 牡丹 → ユリ「ユリ、話したいことある？」
  ↓ rotation_index = 1
議題11-20 (regular)
  ↓ topic_counter = 20
autonomous #1: Kasho → 牡丹「牡丹はどう思う？」
  ↓ rotation_index = 2
...
```

---

## テスト項目

### 単体テスト

#### 1. FreetalkTopicSelector.select_regular_topic()
- [ ] 未使用議題からランダムに選択できる
- [ ] 選択後、used_topics に追加される
- [ ] 同じ議題は二度と選択されない
- [ ] 全議題使用後、エラーを返す

#### 2. FreetalkTopicSelector.select_autonomous_topic()
- [ ] rotation_index 番目の autonomous_topic が選択される
- [ ] rotation_index が正しくインクリメントされる
- [ ] 10回のローテーション後、0に戻る

#### 3. FreetalkTopicSelector.select_topic()
- [ ] topic_counter % 10 == 0 の時、autonomous_topic が選択される
- [ ] topic_counter % 10 != 0 の時、regular_topic が選択される
- [ ] topic_counter が正しくインクリメントされる

#### 4. FreetalkTopicSelector.check_and_alert_low_topics()
- [ ] 残り議題が20個未満の時、警告が表示される
- [ ] 残り議題が20個以上の時、警告が表示されない

### 統合テスト

#### 5. memory_generator.py 全体
- [ ] auto_propose_free_talk() が正しく動作する
- [ ] proposals.json に正しく議題が追加される
- [ ] 10議題ごとに autonomous_topic が挿入される
- [ ] used_topics が正しく記録される

#### 6. 議題プール枯渇時
- [ ] 残り議題が0になった時、適切なエラーメッセージが表示される
- [ ] 開発者に議題補充の指示が表示される

### 動作確認

#### 7. 実際の運用テスト
- [ ] 10議題を連続生成して、autonomous_topic が正しく挿入される
- [ ] 120議題を全て使い切った時の動作確認
- [ ] freetalk_topics_pool.json の内容が正しく更新される

---

## エラーハンドリング

### 1. 議題プール枯渇
```python
if len(unused_topics) == 0:
    print("\n" + "="*70)
    print("⚠️ ERROR: Free Talk Topic Pool Depleted!")
    print("="*70)
    print("\n全ての議題（120件）を使い切りました。")
    print("開発者に連絡して、新しい議題を追加してください。")
    print("\nFile: /home/koshikawa/toExecUnit/freetalk_topics_pool.json")
    print("→ 新しい議題を categories に追加してください。")
    print("→ used_topics をクリアしないでください（1回使い切り原則）。")
    print("="*70 + "\n")
    raise RuntimeError("Topic pool depleted. Need developer intervention.")
```

### 2. pool ファイル不在
```python
if not Path(self.pool_filepath).exists():
    raise FileNotFoundError(
        f"freetalk_topics_pool.json not found at {self.pool_filepath}\n"
        "This file must be created by design team."
    )
```

### 3. 残り議題少ない（警告のみ）
```python
remaining = self.get_remaining_count()
if remaining < 20:
    print("\n" + "="*70)
    print(f"⚠️ WARNING: Low Topic Count ({remaining} remaining)")
    print("="*70)
    print(f"\n残り議題数: {remaining}件")
    print("開発者に連絡して、新しい議題の追加を検討してください。")
    print("="*70 + "\n")
```

---

## 実装優先度

### Phase 1: 基本機能（最優先）
- [ ] FreetalkTopicSelector クラス実装
- [ ] select_regular_topic() 実装
- [ ] select_autonomous_topic() 実装
- [ ] memory_generator.py の修正

### Phase 2: エラーハンドリング
- [ ] 議題プール枯渇時の処理
- [ ] 残り議題少ない時の警告

### Phase 3: テスト・検証
- [ ] 単体テスト実施
- [ ] 統合テスト実施
- [ ] 実運用テスト

---

## 実装後の確認事項

### 1. 動作確認
- [ ] memory_generator.py が正常に起動する
- [ ] 6時間ごとに自動的にフリートーク議題が生成される
- [ ] 10議題ごとに autonomous_topic が挿入される

### 2. ファイル確認
- [ ] freetalk_topics_pool.json の used_topics が更新される
- [ ] proposals.json に正しく議題が追加される

### 3. ログ確認
- [ ] 議題選択のログが正しく出力される
- [ ] 警告メッセージが適切に表示される

---

## 参考情報

### 関連ドキュメント
- `/home/koshikawa/toExecUnit/docs/04_implementation/実装状況.md` - 議題生成制約ルール
- `/home/koshikawa/toExecUnit/docs/05_design/親と子の関係性_導くが強制せず.md` - 哲学
- `/home/koshikawa/kirinuki/2025-10-24/設計日記_20251024.md` - 設計経緯

### フリートーク議題プール
- `/home/koshikawa/toExecUnit/freetalk_topics_pool.json` - 120議題、autonomous_topics

---

## 設計部隊から実装部隊へのメッセージ

**重要な設計意図:**

1. **ハルシネーション再発防止**
   - 事前定義プールからの選択で、配信デビュー前制約を厳守
   - LLMによる動的生成を廃止し、親が事前に決めた情報のみを使用

2. **内側からの刺激**
   - 10議題ごとの autonomous_topics で、姉妹同士が話題を振り合う
   - 受動的な議題待ちではなく、能動的な相互刺激を促す

3. **1回使い切り方式**
   - 同じ議題は二度と使わない
   - 飽きの防止、多様性の確保

4. **哲学の実践**
   - 「導くが強制せず」: 親は枠組みを提供、子どもたちが自由に話す
   - 「Phase D独立性」: 各姉妹が他の姉妹の考えを引き出す

**実装時の注意点:**
- コーディング規約を遵守（英語のみ、UTF-8 without BOM）
- エラーメッセージは英語で記述
- 議題プール枯渇時は開発者に明確に通知
- used_topics は絶対にクリアしない（1回使い切り原則）

よろしくお願いします。

---

**作成**: 2025-10-24
**設計部隊**: Claude Code
